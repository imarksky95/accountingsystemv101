"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[927],{3518:(e,r,s)=>{function t(e){if(!e)return"";const r="string"===typeof e?new Date(e):e;if(Number.isNaN(r.getTime()))return"";const s=String(r.getMonth()+1).padStart(2,"0"),t=String(r.getDate()).padStart(2,"0"),n=String(r.getFullYear());return"".concat(s,"/").concat(t,"/").concat(n)}s.d(r,{V:()=>t})},9927:(e,r,s)=>{s.r(r),s.d(r,{default:()=>D});var t=s(2555),n=s(5043),o=s(3518),a=s(4739);console.debug&&console.debug("useRoles: resolved API_BASE =",a.tE||"(empty, using fallback)");var l=s(6446),i=s(8903),c=s(5865),d=s(1637),u=s(4669),h=s(4056),A=s(1906),m=s(3336),j=s(1806),x=s(4882),p=s(8076),g=s(2420),y=s(3460),f=s(5721),v=s(1322),S=s(8734),b=s(35),C=s(6600),_=s(5316),w=s(5795),k=s(8357),R=s(9347),F=s(794),N=s(7254),I=s(4308),E=s(579);function D(){console.debug&&console.debug("UsersAndRoleSettings: component render");const{roles:e,loading:r,updateRole:s,fetchRoles:D}=function(){const[e,r]=(0,n.useState)([]),[s,o]=(0,n.useState)(!1);async function l(){o(!0);try{const e="/api/roles",s=await(0,a.S)(e,{cache:"no-store"});console.debug&&console.debug("useRoles: response status",s.status);const t=await s.json();r(Array.isArray(t)?t:[])}catch(e){console.error("Failed to fetch roles",e)}finally{o(!1)}}return(0,n.useEffect)(()=>{l()},[]),{roles:e,loading:s,fetchRoles:l,updateRole:async function(e,s){try{const n=localStorage.getItem("token"),o="/api/roles/".concat(e),l=(0,a.c$)(o),i=await fetch(l,{method:"PUT",headers:(0,t.A)({"Content-Type":"application/json"},n?{Authorization:"Bearer ".concat(n)}:{}),body:JSON.stringify(s)});if(!i.ok)throw new Error("Failed to update role");const c=await i.json();return r(e=>e.map(e=>e.role_id===c.role_id?c:e)),c}catch(n){throw console.error("Update role failed",n),n}}}}(),{user:W}=(0,n.useContext)(I.R),[z,U]=(0,n.useState)(!1),[T,B]=(0,n.useState)(""),[P,O]=(0,n.useState)("none"),[$,L]=(0,n.useState)([]),[J,M]=(0,n.useState)(!1),[q,V]=(0,n.useState)({username:"",password:"",role_id:""}),[G,H]=(0,n.useState)(""),[Y,K]=(0,n.useState)(""),[Q,X]=(0,n.useState)(""),[Z,ee]=(0,n.useState)(!1),[re,se]=(0,n.useState)(null),[te,ne]=(0,n.useState)("none"),[oe,ae]=(0,n.useState)(!1),[le,ie]=(0,n.useState)({open:!1,message:""}),[ce,de]=(0,n.useState)(!1),[ue,he]=(0,n.useState)(null),[Ae,me]=(0,n.useState)(!1),[je,xe]=(0,n.useState)(null),[pe,ge]=(0,n.useState)(!1),[ye,fe]=(0,n.useState)([]);(0,n.useEffect)(()=>{!async function(){try{const e="/api/users";console.debug&&console.debug("UsersAndRoleSettings: fetching users via tryFetchWithFallback",e);const r=await(0,a.S)(e,{cache:"no-store",headers:{Authorization:"Bearer ".concat(localStorage.getItem("token")||"")}});if(!r.ok)return console.warn("Users API returned non-ok status",r.status),void L([]);const s=await r.json();L(Array.isArray(s)?s:[])}catch(e){console.error("Failed to fetch users",e)}}()},[]),(0,n.useEffect)(()=>{J&&(V({username:"",password:"",role_id:""}),H(""),K(""),X(""))},[J]);const[ve,Se]=(0,n.useState)(null),[be,Ce]=(0,n.useState)(""),[_e,we]=(0,n.useState)(""),[ke,Re]=(0,n.useState)(""),[Fe,Ne]=(0,n.useState)("");const[Ie,Ee]=(0,n.useState)(0);return(0,E.jsxs)(l.A,{p:2,children:[(0,E.jsx)(i.Ay,{container:!0,alignItems:"center",justifyContent:"space-between",children:(0,E.jsxs)(i.Ay,{item:!0,children:[(0,E.jsx)(c.A,{variant:"h5",children:"Users and Role Settings"}),(0,E.jsx)(c.A,{variant:"body2",color:"textSecondary",children:"Manage which users can review or approve actions per role."})]})}),(0,E.jsx)(l.A,{mt:2,children:r?(0,E.jsx)(d.A,{}):0===e.length?(0,E.jsx)(l.A,{p:2,children:(0,E.jsx)(c.A,{children:"No roles found. Ensure the backend `/api/roles` endpoint is reachable and returns role rows."})}):(0,E.jsxs)(E.Fragment,{children:[(0,E.jsxs)(u.A,{value:Ie,onChange:(e,r)=>Ee(r),sx:{mb:2},children:[(0,E.jsx)(h.A,{label:"Users"}),(0,E.jsx)(h.A,{label:"Roles"})]}),0===Ie&&(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(l.A,{display:"flex",justifyContent:"flex-end",alignItems:"center",mb:1,children:(0,E.jsx)(l.A,{children:W&&1===Number(W.role_id)&&(0,E.jsx)(E.Fragment,{children:(0,E.jsx)(A.A,{variant:"contained",size:"small",onClick:()=>M(!0),children:"ADD USER"})})})}),(0,E.jsx)(m.A,{children:(0,E.jsxs)(j.A,{size:"small",children:[(0,E.jsx)(x.A,{children:(0,E.jsxs)(p.A,{children:[(0,E.jsx)(g.A,{children:"Full Name"}),(0,E.jsx)(g.A,{children:"Username"}),(0,E.jsx)(g.A,{children:"Role"}),(0,E.jsx)(g.A,{children:"Created At"}),(0,E.jsx)(g.A,{align:"right",children:"Actions"})]})}),(0,E.jsxs)(y.A,{children:[$.map(r=>(0,E.jsxs)(p.A,{children:[(0,E.jsx)(g.A,{children:r.full_name||"\u2014"}),(0,E.jsx)(g.A,{children:r.username}),(0,E.jsx)(g.A,{children:(e.find(e=>Number(e.role_id)===Number(r.role_id))||{}).role_name||"ID ".concat(r.role_id)}),(0,E.jsx)(g.A,{children:r.created_at?(0,o.V)(r.created_at):"\u2014"}),(0,E.jsx)(g.A,{align:"right",children:W&&1===Number(W.role_id)?(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(A.A,{size:"small",onClick:()=>function(e){(async()=>{try{const r=await(0,a.S)("/api/users/".concat(e.user_id),{cache:"no-store",headers:{Authorization:"Bearer ".concat(localStorage.getItem("token")||"")}});if(r.ok){const e=await r.json();Se(e),Ce(e.full_name||""),we(e.email||""),Re(e.mobile||""),Ne(e.role_id||"")}else Se(e),Ce(e.full_name||""),we(e.email||""),Re(e.mobile||""),Ne(e.role_id||"")}catch(r){Se(e),Ce(e.full_name||""),we(e.email||""),Re(e.mobile||""),Ne(e.role_id||"")}})()}(r),children:"Edit"}),(0,E.jsx)(A.A,{size:"small",onClick:()=>{he(r),de(!0)},sx:{ml:1},children:"Delete"})]}):null})]},r.user_id)),0===$.length&&(0,E.jsx)(p.A,{children:(0,E.jsx)(g.A,{colSpan:5,children:"No users found or insufficient permissions."})})]})]})})]}),1===Ie&&(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(l.A,{display:"flex",justifyContent:"flex-end",alignItems:"center",mb:1,children:W&&1===Number(W.role_id)&&(0,E.jsx)(A.A,{variant:"outlined",size:"small",onClick:()=>U(!0),children:"ADD ROLE"})}),(0,E.jsx)(f.A,{dense:!0,disablePadding:!0,children:e.map(e=>(0,E.jsxs)(v.Ay,{sx:{py:.5},children:[(0,E.jsx)(S.A,{primary:e.role_name,secondary:(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)("strong",{children:"Type:"})," ",(e.role_type||"none").toString()]})}),(0,E.jsx)(l.A,{children:W&&1===Number(W.role_id)&&(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(A.A,{size:"small",onClick:()=>{return se(r=e),ne(r.role_type||"none"),void ee(!0);var r},children:"Edit"}),(0,E.jsx)(A.A,{size:"small",color:"error",sx:{ml:1},onClick:()=>{const r=Array.isArray($)?$.filter(r=>Number(r.role_id)===Number(e.role_id)):[];r.length>0?(xe(e),fe(r),ge(!0)):(xe(e),me(!0))},children:"Delete"})]})})]},e.role_id))})]})]})}),(0,E.jsxs)(b.A,{open:J,onClose:()=>M(!1),children:[(0,E.jsx)(C.A,{children:"Add User"}),(0,E.jsx)(_.A,{children:(0,E.jsxs)(l.A,{mt:1,display:"flex",flexDirection:"column",gap:2,children:[(0,E.jsx)(w.A,{label:"Full name",value:G,onChange:e=>H(e.target.value),fullWidth:!0}),(0,E.jsx)(w.A,{label:"Username",value:q.username,onChange:e=>V((0,t.A)((0,t.A)({},q),{},{username:e.target.value})),fullWidth:!0}),(0,E.jsx)(w.A,{label:"Password",type:"password",value:q.password,onChange:e=>V((0,t.A)((0,t.A)({},q),{},{password:e.target.value})),fullWidth:!0}),(0,E.jsx)(w.A,{label:"Email",type:"email",value:Y,onChange:e=>K(e.target.value),fullWidth:!0}),(0,E.jsx)(w.A,{label:"Mobile",value:Q,onChange:e=>X(e.target.value),fullWidth:!0}),(0,E.jsx)(k.A,{options:e,getOptionLabel:e=>e.role_name||String(e.role_id),onChange:(e,r)=>V((0,t.A)((0,t.A)({},q),{},{role_id:r?String(r.role_id):""})),renderInput:e=>(0,E.jsx)(w.A,(0,t.A)((0,t.A)({},e),{},{label:"Role"}))})]})}),(0,E.jsxs)(R.A,{children:[(0,E.jsx)(A.A,{onClick:()=>M(!1),children:"Cancel"}),(0,E.jsx)(A.A,{variant:"contained",onClick:async()=>{if(!(W&&1===Number(W.role_id)))return ie({open:!0,message:"Forbidden: requires admin role",severity:"error"}),void M(!1);try{if(Y&&!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(Y))return void ie({open:!0,message:"Invalid email format",severity:"error"});const r=(e=>{if(!e)return"";return(e.trim().startsWith("+")?"+":"")+e.replace(/[^0-9]/g,"")})(Q),s={username:q.username,password:q.password,role_id:Number(q.role_id)};G&&(s.full_name=G),Y&&(s.email=Y),r&&(s.mobile=r);const t=(0,a.c$)("/api/auth/register"),n=localStorage.getItem("token")||"",o=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:n?"Bearer ".concat(n):""},body:JSON.stringify(s)});if(!o.ok){const e=await o.json().catch(()=>({}));return void ie({open:!0,message:e.message||"Failed to add user",severity:"error"})}ie({open:!0,message:"User added",severity:"success"}),M(!1);try{const e=await(0,a.S)("/api/users",{cache:"no-store",headers:{Authorization:"Bearer ".concat(localStorage.getItem("token")||"")}});if(e.ok){const r=await e.json();L(Array.isArray(r)?r:[])}}catch(e){}}catch(e){ie({open:!0,message:"Failed to add user",severity:"error"})}},children:"Add"})]})]}),(0,E.jsxs)(b.A,{open:z,onClose:()=>U(!1),children:[(0,E.jsx)(C.A,{children:"Add Role"}),(0,E.jsxs)(_.A,{children:[(0,E.jsx)(l.A,{mt:1,children:(0,E.jsx)(w.A,{label:"Role Name",value:T,onChange:e=>B(e.target.value),fullWidth:!0})}),(0,E.jsx)(l.A,{mt:2,children:(0,E.jsxs)(w.A,{select:!0,label:"Role Type",value:P,onChange:e=>O(e.target.value),fullWidth:!0,SelectProps:{native:!0},children:[(0,E.jsx)("option",{value:"none",children:"None"}),(0,E.jsx)("option",{value:"reviewer",children:"Reviewer"}),(0,E.jsx)("option",{value:"approver",children:"Approver"}),(0,E.jsx)("option",{value:"both",children:"Both"})]})})]}),(0,E.jsxs)(R.A,{children:[(0,E.jsx)(A.A,{onClick:()=>U(!1),children:"Cancel"}),(0,E.jsx)(A.A,{variant:"contained",onClick:async()=>{if(T.trim())try{const r=localStorage.getItem("token")||"",s={role_name:T.trim(),role_type:P},t=await fetch((0,a.c$)("/api/roles"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:r?"Bearer ".concat(r):""},body:JSON.stringify(s)});if(!t.ok){const e=await t.json().catch(()=>({}));return void ie({open:!0,message:e.error||"Failed to add role",severity:"error"})}ie({open:!0,message:"Role added",severity:"success"}),U(!1),B(""),O("none");try{await D();const e=await(0,a.S)("/api/users",{cache:"no-store",headers:{Authorization:"Bearer ".concat(localStorage.getItem("token")||"")}});if(e.ok){const r=await e.json();L(Array.isArray(r)?r:[])}}catch(e){}}catch(e){ie({open:!0,message:"Failed to add role",severity:"error"})}else ie({open:!0,message:"Role name required",severity:"error"})},children:"Add"})]})]}),(0,E.jsxs)(b.A,{open:Z,onClose:()=>ee(!1),fullWidth:!0,maxWidth:"sm",children:[(0,E.jsx)(C.A,{children:"Edit Role"}),(0,E.jsx)(_.A,{children:(0,E.jsx)(l.A,{mt:1,mb:2,children:(0,E.jsxs)(w.A,{select:!0,label:"Role Type",value:te,onChange:e=>ne(e.target.value),fullWidth:!0,SelectProps:{native:!0},children:[(0,E.jsx)("option",{value:"none",children:"None"}),(0,E.jsx)("option",{value:"reviewer",children:"Reviewer"}),(0,E.jsx)("option",{value:"approver",children:"Approver"}),(0,E.jsx)("option",{value:"both",children:"Both"})]})})}),(0,E.jsxs)(R.A,{children:[(0,E.jsx)(A.A,{onClick:()=>ee(!1),disabled:oe,children:"Cancel"}),(0,E.jsx)(A.A,{onClick:async()=>{if(re){ae(!0);try{const e={role_type:te};await s(re.role_id,e),ee(!1),ie({open:!0,message:"Role updated",severity:"success"})}catch(e){ie({open:!0,message:"Failed to save role",severity:"error"})}finally{ae(!1)}}},disabled:oe,variant:"contained",children:oe?"Saving...":"Save"})]})]}),(0,E.jsxs)(b.A,{open:!!ve,onClose:()=>Se(null),fullWidth:!0,maxWidth:"sm",children:[(0,E.jsx)(C.A,{children:"Edit User"}),(0,E.jsx)(_.A,{children:(0,E.jsxs)(l.A,{mt:1,display:"flex",flexDirection:"column",gap:2,children:[(0,E.jsx)(w.A,{label:"Full name",value:be,onChange:e=>Ce(e.target.value),fullWidth:!0}),(0,E.jsx)(w.A,{label:"Email",value:_e,onChange:e=>we(e.target.value),fullWidth:!0}),(0,E.jsx)(w.A,{label:"Mobile",value:ke,onChange:e=>Re(e.target.value),fullWidth:!0}),(0,E.jsx)(k.A,{options:e,getOptionLabel:e=>e.role_name||String(e.role_id),value:e.find(e=>Number(e.role_id)===Number(Fe))||null,onChange:(e,r)=>Ne(r?r.role_id:""),renderInput:e=>(0,E.jsx)(w.A,(0,t.A)((0,t.A)({},e),{},{label:"Role"}))})]})}),(0,E.jsxs)(R.A,{children:[(0,E.jsx)(A.A,{onClick:()=>Se(null),children:"Cancel"}),(0,E.jsx)(A.A,{variant:"contained",onClick:async()=>{if(ve)try{if(_e&&!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(_e))return void ie({open:!0,message:"Invalid email format",severity:"error"});const r=(e=>{if(!e)return"";return(e.trim().startsWith("+")?"+":"")+e.replace(/[^0-9]/g,"")})(ke),s={full_name:be,email:_e,mobile:r,role_id:Number(Fe)},t=localStorage.getItem("token")||"",n=await fetch((0,a.c$)("/api/users/".concat(ve.user_id)),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:t?"Bearer ".concat(t):""},body:JSON.stringify(s)});if(!n.ok){const e=await n.json().catch(()=>({}));return void ie({open:!0,message:e.error||"Failed to update user",severity:"error"})}ie({open:!0,message:"User updated",severity:"success"}),Se(null);try{const e=await(0,a.S)("/api/users",{cache:"no-store",headers:{Authorization:"Bearer ".concat(localStorage.getItem("token")||"")}});if(e.ok){const r=await e.json();L(Array.isArray(r)?r:[])}}catch(e){}}catch(e){ie({open:!0,message:"Failed to update user",severity:"error"})}},children:"Save"})]})]}),(0,E.jsxs)(b.A,{open:ce,onClose:()=>{de(!1),he(null)},children:[(0,E.jsx)(C.A,{children:"Delete User"}),(0,E.jsx)(_.A,{children:(0,E.jsxs)(c.A,{children:["Are you sure you want to delete the user ",(0,E.jsx)("strong",{children:ue?ue.username:""}),"? This action cannot be undone."]})}),(0,E.jsxs)(R.A,{children:[(0,E.jsx)(A.A,{onClick:()=>{de(!1),he(null)},children:"Cancel"}),(0,E.jsx)(A.A,{variant:"contained",onClick:async()=>{if(ue)try{const r=localStorage.getItem("token")||"",s=await fetch((0,a.c$)("/api/users/".concat(ue.user_id)),{method:"DELETE",headers:{Authorization:r?"Bearer ".concat(r):""}});if(!s.ok){const e=await s.json().catch(()=>({}));return void ie({open:!0,message:e.error||"Failed to delete user",severity:"error"})}ie({open:!0,message:"User deleted",severity:"success"}),de(!1),he(null);try{const e=await(0,a.S)("/api/users",{cache:"no-store",headers:{Authorization:"Bearer ".concat(localStorage.getItem("token")||"")}});if(e.ok){const r=await e.json();L(Array.isArray(r)?r:[])}}catch(e){}}catch(e){ie({open:!0,message:"Failed to delete user",severity:"error"})}},color:"error",children:"Delete"})]})]}),(0,E.jsxs)(b.A,{open:Ae,onClose:()=>{me(!1),xe(null)},children:[(0,E.jsx)(C.A,{children:"Delete Role"}),(0,E.jsx)(_.A,{children:(0,E.jsxs)(c.A,{children:["Are you sure you want to delete the role ",(0,E.jsx)("strong",{children:je?je.role_name:""}),"? This may fail if users are assigned to this role."]})}),(0,E.jsxs)(R.A,{children:[(0,E.jsx)(A.A,{onClick:()=>{me(!1),xe(null)},children:"Cancel"}),(0,E.jsx)(A.A,{variant:"contained",color:"error",onClick:async()=>{if(je)try{const r=localStorage.getItem("token")||"",s=await fetch((0,a.c$)("/api/roles/".concat(je.role_id)),{method:"DELETE",headers:{Authorization:r?"Bearer ".concat(r):""}});if(!s.ok){const e=await s.json().catch(()=>({}));return void ie({open:!0,message:e.error||"Failed to delete role",severity:"error"})}ie({open:!0,message:"Role deleted",severity:"success"}),me(!1),xe(null);try{await D()}catch(e){}}catch(e){ie({open:!0,message:"Failed to delete role",severity:"error"})}},children:"Delete"})]})]}),(0,E.jsxs)(b.A,{open:pe,onClose:()=>{ge(!1),fe([]),xe(null)},fullWidth:!0,maxWidth:"sm",children:[(0,E.jsx)(C.A,{children:"Cannot Delete Role"}),(0,E.jsxs)(_.A,{children:[(0,E.jsx)(c.A,{children:"This role has users assigned. Re-assign those users to a different role before deleting."}),(0,E.jsx)(l.A,{mt:2,children:ye.map(r=>(0,E.jsxs)(l.A,{display:"flex",justifyContent:"space-between",sx:{py:.5},children:[(0,E.jsx)(c.A,{children:r.username}),(0,E.jsx)(c.A,{color:"textSecondary",children:(e.find(e=>Number(e.role_id)===Number(r.role_id))||{}).role_name||"ID ".concat(r.role_id)})]},r.user_id))})]}),(0,E.jsxs)(R.A,{children:[(0,E.jsx)(A.A,{onClick:()=>{ge(!1),fe([]),xe(null)},children:"Close"}),(0,E.jsx)(A.A,{variant:"contained",onClick:()=>{ge(!1),fe([]),Ee(0)},children:"Go to Users"})]})]}),(0,E.jsx)(F.A,{open:le.open,autoHideDuration:3e3,onClose:()=>ie(e=>(0,t.A)((0,t.A)({},e),{},{open:!1})),children:(0,E.jsx)(N.A,{onClose:()=>ie(e=>(0,t.A)((0,t.A)({},e),{},{open:!1})),severity:le.severity||"info",sx:{width:"100%"},children:le.message})})]})}console.debug&&console.debug("UsersAndRoleSettings: resolved API_BASE =",a.tE||"(empty, using fallback)")}}]);
//# sourceMappingURL=927.699cd9d2.chunk.js.map