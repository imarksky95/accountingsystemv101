"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[46],{2046:(e,t,n)=>{n.r(t),n.d(t,{default:()=>H});var r=n(5043),a=n(6446),i=n(3336),l=n(4669),s=n(4056),o=n(2555),c=n(1906),d=n(1637),u=n(1806),p=n(4882),h=n(8076),_=n(2420),m=n(3460),y=n(3217),v=n(35),x=n(6600),A=n(7392),j=n(5316),g=n(5795),b=n(3193),f=n(9190),w=n(2221),k=n(1449),S=n(9347),C=n(794),N=n(7254),P=n(4802),B=n(9722),T=n(4308),D=n(4739),I=n(3518),W=n(579);console.debug&&console.debug("PaymentVouchers: resolved API_BASE =",D.tE||"(empty, using fallback)");const z={status:"Draft",preparation_date:"",purpose:"",paid_through:"",prepared_by:null,description:"",payment_lines:[],journal_lines:[]},R=()=>{const{user:e}=(0,r.useContext)(T.R),[t,n]=(0,r.useState)([]),[i,l]=(0,r.useState)(!1),[s,R]=(0,r.useState)([]),[E,V]=(0,r.useState)([]),[O,$]=(0,r.useState)(!1),[L,F]=(0,r.useState)(null),[q,H]=(0,r.useState)(z),[J,U]=(0,r.useState)(""),M=(0,r.useRef)(null),[Y,G]=(0,r.useState)(null),[K,Q]=(0,r.useState)({}),[X,Z]=(0,r.useState)(!1),[ee,te]=(0,r.useState)(null),ne=e=>{if(void 0===e||null===e||""===e)return[];if(Array.isArray(e))return e.map(String).filter(Boolean);if("number"===typeof e)return[String(e)];if("string"===typeof e){try{const t=JSON.parse(e);if(Array.isArray(t))return t.map(String).filter(Boolean);if("number"===typeof t||"string"===typeof t)return[String(t)]}catch(t){}const n=e.match(/\d+/);return n?[n[0]]:[]}return[]},re=e=>{const t=ne(e);return t.length?t.map(e=>K[String(e)]||String(e)).join(", "):e&&"string"===typeof e?e:""},[ae,ie]=(0,r.useState)(null),[le,se]=(0,r.useState)(!1),[oe,ce]=(0,r.useState)({}),[de,ue]=(0,r.useState)(!1),[pe,he]=(0,r.useState)(""),[_e,me]=(0,r.useState)("info"),ye=(0,r.useCallback)(async()=>{l(!0);try{let l=[];try{const e=await B.A.get((0,D.c$)("/api/payment-vouchers"));l=Array.isArray(e.data)?e.data:[]}catch(s){var e;console.error("payment-vouchers fetch error",(null===s||void 0===s||null===(e=s.response)||void 0===e?void 0:e.data)||s.message||s)}n(l);try{const e={},t=new Set;for(const n of l)if(n.prepared_by_username)e[String(n.prepared_by)]=n.prepared_by_username;else if(n.prepared_by&&!isNaN(Number(n.prepared_by))){const e=String(n.prepared_by);K[e]||t.add(e)}if(Object.keys(e).length&&Q(t=>(0,o.A)((0,o.A)({},t),e)),t.size){const e=localStorage.getItem("token");await Promise.all(Array.from(t).map(async t=>{try{const n=await B.A.get((0,D.c$)("/api/users/".concat(t)),{headers:e?{Authorization:"Bearer ".concat(e)}:{}});n&&n.data&&Q(e=>(0,o.A)((0,o.A)({},e),{},{[t]:n.data.full_name||n.data.username||t}))}catch(n){}}))}}catch(c){}let u=[];try{const e=await B.A.get((0,D.c$)("/api/contacts"));u=Array.isArray(e.data)?e.data:[]}catch(s){var t;console.error("contacts fetch error",(null===s||void 0===s||null===(t=s.response)||void 0===t?void 0:t.data)||s.message||s),u=[]}if(0===u.length)try{const e=await B.A.get((0,D.c$)("/api/vendors")),t=(Array.isArray(e.data)?e.data:[]).map(e=>({contact_id:e.vendor_id,display_name:e.name,contact_type:"Vendor"}));console.log("contacts empty; using vendors fallback count=",t.length,t.slice(0,5)),R(t)}catch(c){var r;console.error("vendors fallback fetch error",(null===c||void 0===c||null===(r=c.response)||void 0===r?void 0:r.data)||c.message||c),R([])}else console.log("contacts fetched count=",u.length,u.slice(0,5)),R(u);try{const e=await B.A.get((0,D.c$)("/api/coa/all/simple")),t=Array.isArray(e.data)?e.data:[];console.log("coas fetched count=",t.length,t.slice(0,5)),V(t)}catch(s){var a;console.warn("coa fetch primary failed, trying fallback",(null===s||void 0===s||null===(a=s.response)||void 0===a?void 0:a.data)||s.message||s);try{const e=await B.A.get((0,D.c$)("/api/coa/all/simple/fallback")),t=Array.isArray(e.data)?e.data:[];console.log("coa fetched fallback count=",t.length,t.slice(0,5)),V(t)}catch(d){var i;console.error("coa fetch fallback failed",(null===d||void 0===d||null===(i=d.response)||void 0===i?void 0:i.data)||d.message||d),V([])}}}catch(c){console.error("fetchAll error",c)}finally{l(!1)}},[K]),ve=async()=>{try{const e=await(0,D.S)("/api/coa/all/simple");if(!e.ok)throw new Error("COA primary fetch failed: ".concat(e.status));const t=await e.json(),n=Array.isArray(t)?t:[];return V(n),n}catch(e){console.warn("coa fetch primary failed, trying fallback",(null===e||void 0===e?void 0:e.message)||e);try{const e=await(0,D.S)("/api/coa/all/simple/fallback");if(!e.ok)throw new Error("COA fallback fetch failed: ".concat(e.status));const t=await e.json(),n=Array.isArray(t)?t:[];return V(n),n}catch(t){return console.error("coa fetch fallback failed",(null===t||void 0===t?void 0:t.message)||t),V([]),[]}}},xe=async()=>{try{const t=await B.A.get((0,D.c$)("/api/contacts")),r=Array.isArray(t.data)?t.data:[];if(!r||0===r.length)try{const e=await B.A.get((0,D.c$)("/api/vendors")),t=(Array.isArray(e.data)?e.data:[]).map(e=>({contact_id:e.vendor_id,display_name:e.name,contact_type:"Vendor"}));return R(t),t}catch(n){var e;return console.error("vendors fallback fetch error",(null===n||void 0===n||null===(e=n.response)||void 0===e?void 0:e.data)||n.message||n),R([]),[]}return R(r),r}catch(r){var t;return console.error("contacts fetch error",(null===r||void 0===r||null===(t=r.response)||void 0===t?void 0:t.data)||r.message||r),R([]),[]}};r.useEffect(()=>{ye()},[ye]),r.useEffect(()=>{O&&setTimeout(()=>{try{var e;null===(e=M.current)||void 0===e||e.focus()}catch(t){}},0)},[O]),r.useEffect(()=>{(0,D.S)("/api/company-profile",{cache:"no-store"}).then(e=>e.ok?e.json().then(e=>G(e)):G(null)).catch(()=>G(null))},[]);return(0,W.jsxs)(a.A,{children:[(0,W.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,W.jsx)("h3",{children:"Payment Vouchers"}),(0,W.jsxs)("div",{children:[(0,W.jsx)(c.A,{variant:"contained",onClick:async()=>{await Promise.all([xe(),ve()]);try{const e=await B.A.get((0,D.c$)("/api/payment-vouchers/simple")),t=Array.isArray(e.data)?e.data:[];U("PV-".concat(t.length+1))}catch(i){var t;console.warn("failed to compute expected control",(null===i||void 0===i||null===(t=i.response)||void 0===t?void 0:t.data)||i.message||i),U("")}F(null);let n=null;try{const e=localStorage.getItem("token"),t=await B.A.get((0,D.c$)("/api/auth/me"),{headers:e?{Authorization:"Bearer ".concat(e)}:{}});t&&t.data&&(n=t.data)}catch(i){n=e}let r="",a="";try{const e=n;if(e){const t=e;t.reviewer_id?r=t.reviewer_id:t.reviewer_manual&&(r=t.reviewer_manual),t.approver_id?a=t.approver_id:t.approver_manual&&(a=t.approver_manual)}e&&e.user_id&&Q(t=>(0,o.A)((0,o.A)({},t),{},{[String(e.user_id)]:e.full_name||e.username||String(e.user_id)}));try{const t=localStorage.getItem("token");if(e&&e.reviewer_id&&!isNaN(Number(e.reviewer_id))){const n=String(e.reviewer_id);B.A.get((0,D.c$)("/api/users/".concat(n)),{headers:t?{Authorization:"Bearer ".concat(t)}:{}}).then(e=>{e&&e.data&&Q(t=>(0,o.A)((0,o.A)({},t),{},{[n]:e.data.full_name||e.data.username||n}))}).catch(()=>{})}if(e&&e.approver_id&&!isNaN(Number(e.approver_id))){const n=String(e.approver_id);B.A.get((0,D.c$)("/api/users/".concat(n)),{headers:t?{Authorization:"Bearer ".concat(t)}:{}}).then(e=>{e&&e.data&&Q(t=>(0,o.A)((0,o.A)({},t),{},{[n]:e.data.full_name||e.data.username||n}))}).catch(()=>{})}}catch(i){}}catch(i){}H((0,o.A)((0,o.A)({},z),{},{preparation_date:(new Date).toISOString().slice(0,10),prepared_by:n&&n.user_id?n.user_id:(null===e||void 0===e?void 0:e.user_id)||null,reviewed_by:r,approved_by:a,payment_lines:[{payee_id:"",description:"",amount:0}],journal_lines:[{coa_id:"",debit:0,credit:0,remarks:""}]}));try{const e=localStorage.getItem("token");if(r&&!isNaN(Number(r))){const t=String(r);B.A.get((0,D.c$)("/api/users/".concat(t)),{headers:e?{Authorization:"Bearer ".concat(e)}:{}}).then(e=>{e&&e.data&&Q(n=>(0,o.A)((0,o.A)({},n),{},{[t]:e.data.full_name||e.data.username||t}))}).catch(()=>{})}if(a&&!isNaN(Number(a))){const t=String(a);B.A.get((0,D.c$)("/api/users/".concat(t)),{headers:e?{Authorization:"Bearer ".concat(e)}:{}}).then(e=>{e&&e.data&&Q(n=>(0,o.A)((0,o.A)({},n),{},{[t]:e.data.full_name||e.data.username||t}))}).catch(()=>{})}}catch(i){}$(!0)},sx:{mr:1},children:"New PV"}),(0,W.jsx)(c.A,{onClick:()=>ye(),sx:{mr:1},children:"Refresh"}),(0,W.jsx)(c.A,{color:"secondary",variant:"outlined",onClick:()=>ce({}),children:"Clear Selection"})]})]}),i?(0,W.jsx)(d.A,{}):(0,W.jsxs)(u.A,{children:[(0,W.jsx)(p.A,{children:(0,W.jsxs)(h.A,{children:[(0,W.jsx)(_.A,{}),(0,W.jsx)(_.A,{children:"PV Ctrl"}),(0,W.jsx)(_.A,{children:"Prepared"}),(0,W.jsx)(_.A,{children:"Prepared Date"}),(0,W.jsx)(_.A,{children:"Purpose"}),(0,W.jsx)(_.A,{children:"Amount"}),(0,W.jsx)(_.A,{children:"Actions"})]})}),(0,W.jsxs)(m.A,{children:[t.map(t=>(0,W.jsxs)(h.A,{children:[(0,W.jsx)(_.A,{children:(0,W.jsx)(y.A,{checked:!!oe[t.payment_voucher_id],onChange:()=>{return e=t.payment_voucher_id,ce(t=>(0,o.A)((0,o.A)({},t),{},{[e]:!t[e]}));var e}})}),(0,W.jsx)(_.A,{children:t.payment_voucher_control}),(0,W.jsx)(_.A,{children:t.prepared_by_username||(t.prepared_by&&!isNaN(Number(t.prepared_by))?K[String(t.prepared_by)]||String(t.prepared_by):t.prepared_by||"")}),(0,W.jsx)(_.A,{children:(0,I.V)(t.preparation_date)}),(0,W.jsx)(_.A,{children:t.purpose||"-"}),(0,W.jsx)(_.A,{children:t.amount_to_pay||(t.payment_lines&&t.payment_lines.length?t.payment_lines.reduce((e,t)=>e+(Number(t.amount)||0),0):0)}),(0,W.jsxs)(_.A,{children:[(0,W.jsx)(c.A,{size:"small",onClick:()=>(async t=>{await Promise.all([xe(),ve()]),F(t),U(t.payment_voucher_control||"");const n=t.reviewer_id||t.reviewer_manual||t.reviewed_by||t.reviewed_by_manual||"",r=t.approver_id||t.approver_manual||t.approved_by||t.approved_by_manual||"",a=n||e&&(e.reviewer_id||e.reviewer_manual)||"",i=r||e&&(e.approver_id||e.approver_manual)||"";H((0,o.A)((0,o.A)({},t),{},{preparation_date:t.preparation_date&&"string"===typeof t.preparation_date&&-1!==t.preparation_date.indexOf("T")?t.preparation_date.slice(0,10):t.preparation_date,payment_lines:t.payment_lines&&t.payment_lines.length?t.payment_lines.map(e=>({payee_id:e.payee_contact_id?String(e.payee_contact_id):e.payee_id||"",payee_name:e.payee_display||e.payee_name||"",description:e.description||"",amount:e.amount||0})):[{payee_id:"",description:"",amount:0}],journal_lines:t.journal_lines&&t.journal_lines.length?t.journal_lines:[{coa_id:"",debit:0,credit:0,remarks:""}],reviewed_by:a,approved_by:i}));try{const e=localStorage.getItem("token"),n=[],r=a||"",l=i||"",s=t.prepared_by||"";r&&!isNaN(Number(r))&&n.push(String(r)),l&&!isNaN(Number(l))&&n.push(String(l)),s&&!isNaN(Number(s))&&n.push(String(s)),n.length&&await Promise.all(Array.from(new Set(n)).map(async t=>{try{const n=await B.A.get((0,D.c$)("/api/users/".concat(t)),{headers:e?{Authorization:"Bearer ".concat(e)}:{}});n&&n.data&&Q(e=>(0,o.A)((0,o.A)({},e),{},{[t]:n.data.full_name||n.data.username||t}))}catch(n){}}))}catch(l){}$(!0)})(t),sx:{mr:1},children:"Edit"}),(0,W.jsx)(c.A,{size:"small",color:"error",onClick:()=>{return e=t.payment_voucher_id,ie(e),void se(!0);var e},sx:{mr:1},children:"Delete"}),(0,W.jsx)(c.A,{size:"small",onClick:async()=>{try{if(!Y){const e=await(0,D.S)("/api/company-profile",{cache:"no-store"});if(e.ok){const t=await e.json();G(t)}}let n=null;try{const e=localStorage.getItem("token"),r=await B.A.get((0,D.c$)("/api/payment-vouchers/".concat(t.payment_voucher_id)),{headers:e?{Authorization:"Bearer ".concat(e)}:{}});r&&r.data&&(n=r.data)}catch(e){n=null}const r=n||t,a=(r.journal_lines||[]).map(e=>{const t=(0,o.A)({},e);if(!t.account_name){const e=t.coa_id||t.coa;if(void 0!==e&&null!==e&&E&&E.length){const n=E.find(n=>String(n.coa_id)===String(e)||String(n.coa_id)===String(t.coa_id||""));n&&(t.account_name=n.account_name||n.name||"")}}return t}),i=(0,o.A)((0,o.A)({},r),{},{journal_lines:a}),l={};try{const t=e=>void 0!==e&&null!==e?e:"",n=ne(t(i.reviewer_id)||t(i.reviewer_manual)||t(i.reviewed_by)||t(i.reviewed_by_manual)||""),r=ne(t(i.approver_id)||t(i.approver_manual)||t(i.approved_by)||t(i.approved_by_manual)||""),a=ne(t(i.prepared_by)||t(i.prepared_by_manual)||""),s=new Set;for(const e of[...n,...r,...a])e&&!K[String(e)]&&s.add(String(e));if(s.size){const t=localStorage.getItem("token");await Promise.all(Array.from(s).map(async n=>{try{const e=await B.A.get((0,D.c$)("/api/users/".concat(n)),{headers:t?{Authorization:"Bearer ".concat(t)}:{}});e&&e.data&&(l[n]=e.data.full_name||e.data.username||n)}catch(e){}})),Object.keys(l).length&&Q(e=>(0,o.A)((0,o.A)({},e),l))}}catch(e){}if(!i.prepared_by_name){const e=ne(i.prepared_by||i.prepared_by_manual||"");e&&e.length?i.prepared_by_name=K[e[0]]||l[e[0]]||String(e[0]):i.prepared_by_name=i.prepared_by_manual||""}if(!i.reviewed_by_name){const e=ne(i.reviewer_id||i.reviewer_manual||i.reviewed_by||i.reviewed_by_manual||"");e&&e.length?i.reviewed_by_name=K[e[0]]||l[e[0]]||String(e[0]):i.reviewed_by_name=i.reviewer_manual||i.reviewed_by_manual||""}if(!i.approved_by_name){const e=ne(i.approver_id||i.approver_manual||i.approved_by||i.approved_by_manual||"");e&&e.length?i.approved_by_name=K[e[0]]||l[e[0]]||String(e[0]):i.approved_by_name=i.approver_manual||i.approved_by_manual||""}r&&r.reviewerSource&&(i.reviewerSource=r.reviewerSource),r&&r.approverSource&&(i.approverSource=r.approverSource),te(i)}catch(e){try{te(t)}catch(n){te(null)}}Z(!0)},children:"Preview"})]})]},t.payment_voucher_id)),0===t.length&&(0,W.jsx)(h.A,{children:(0,W.jsx)(_.A,{colSpan:7,children:"No payment vouchers found."})})]})]}),(0,W.jsxs)(v.A,{open:O,onClose:()=>$(!1),fullWidth:!0,maxWidth:"lg",children:[(0,W.jsxs)(x.A,{children:[L?"Edit Payment Voucher (".concat(J||L&&L.payment_voucher_control||"",")"):"New Payment Voucher".concat(J?" (expected: "+J+")":""),(0,W.jsx)(A.A,{"aria-label":"close",onClick:()=>$(!1),sx:{position:"absolute",right:8,top:8},children:(0,W.jsx)(P.A,{})})]}),(0,W.jsxs)(j.A,{children:[(0,W.jsxs)(a.A,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:2,mb:2},children:[(0,W.jsx)(g.A,{inputRef:M,label:"Preparation Date",type:"date",value:q.preparation_date||"",onChange:e=>H((0,o.A)((0,o.A)({},q),{},{preparation_date:e.target.value})),InputLabelProps:{shrink:!0}}),(0,W.jsxs)(b.A,{children:[(0,W.jsx)(f.A,{id:"purpose-label",children:"Purpose"}),(0,W.jsxs)(w.A,{labelId:"purpose-label",value:q.purpose||"",label:"Purpose",onChange:e=>H((0,o.A)((0,o.A)({},q),{},{purpose:e.target.value})),children:[(0,W.jsx)(k.A,{value:"",children:"-- Select Purpose --"}),(0,W.jsx)(k.A,{value:"Bills Payment",children:"Bills Payment"}),(0,W.jsx)(k.A,{value:"Liquidation Payouts",children:"Liquidation Payouts"}),(0,W.jsx)(k.A,{value:"Government and Other Agency Payments",children:"Government and Other Agency Payments"}),(0,W.jsx)(k.A,{value:"OSM Request",children:"OSM Request"}),(0,W.jsx)(k.A,{value:"Cash Advance / Budget Request",children:"Cash Advance / Budget Request"}),(0,W.jsx)(k.A,{value:"Other Payments",children:"Other Payments"})]})]})]}),(0,W.jsxs)(a.A,{sx:{mt:2,mb:2},children:[(0,W.jsx)(a.A,{sx:{fontWeight:700,mb:1},children:"PAYMENT DETAILS"}),(0,W.jsxs)(u.A,{size:"small",children:[(0,W.jsx)(p.A,{children:(0,W.jsxs)(h.A,{children:[(0,W.jsx)(_.A,{children:"Payee"}),(0,W.jsx)(_.A,{children:"Description"}),(0,W.jsx)(_.A,{align:"right",children:"Amount to Pay"}),(0,W.jsx)(_.A,{})]})}),(0,W.jsx)(m.A,{children:(q.payment_lines||[]).map((e,t)=>(0,W.jsxs)(h.A,{children:[(0,W.jsx)(_.A,{sx:{minWidth:200},children:(0,W.jsxs)(w.A,{fullWidth:!0,value:e.payee_id||e.payee||"",onChange:e=>{var n;const r=e.target.value,a=(0,o.A)({},q);a.payment_lines=a.payment_lines||[],a.payment_lines[t]=(0,o.A)((0,o.A)({},a.payment_lines[t]||{}),{},{payee_id:r,payee_name:(null===(n=s.find(e=>String(e.contact_id)===String(r)))||void 0===n?void 0:n.display_name)||""}),H(a)},children:[(0,W.jsx)(k.A,{value:"",children:"-- Select Payee --"}),s.map(e=>(0,W.jsxs)(k.A,{value:String(e.contact_id),children:[e.display_name,e.contact_type?" (".concat(e.contact_type,")"):""]},e.contact_id))]})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(g.A,{fullWidth:!0,value:e.description||"",onChange:e=>{const n=(0,o.A)({},q);n.payment_lines=n.payment_lines||[],n.payment_lines[t]=(0,o.A)((0,o.A)({},n.payment_lines[t]||{}),{},{description:e.target.value}),H(n)}})}),(0,W.jsx)(_.A,{align:"right",children:(0,W.jsx)(g.A,{type:"number",value:e.amount||"",onChange:e=>{const n=(0,o.A)({},q);n.payment_lines=n.payment_lines||[],n.payment_lines[t]=(0,o.A)((0,o.A)({},n.payment_lines[t]||{}),{},{amount:e.target.value}),H(n)},InputProps:{sx:{textAlign:"right"}}})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(c.A,{color:"error",onClick:()=>{const e=(0,o.A)({},q);e.payment_lines=e.payment_lines||[],e.payment_lines=e.payment_lines.filter((e,n)=>n!==t),H(e)},children:"Remove"})})]},t))})]}),(0,W.jsx)(a.A,{sx:{mt:1},children:(0,W.jsx)(c.A,{onClick:()=>{const e=(0,o.A)({},q);e.payment_lines=e.payment_lines||[],e.payment_lines.push({payee_id:"",description:"",amount:0}),H(e)},children:"+ Add another line"})}),(0,W.jsxs)(a.A,{sx:{mt:2,textAlign:"right",fontWeight:700},children:["Total Amount to Pay: PHP ",(q.payment_lines||[]).reduce((e,t)=>e+(Number(t.amount)||0),0)]})]}),(0,W.jsxs)(a.A,{sx:{mt:2,mb:2},children:[(0,W.jsx)(a.A,{sx:{fontWeight:700,mb:1},children:"JOURNAL ENTRY"}),(0,W.jsxs)(u.A,{size:"small",children:[(0,W.jsx)(p.A,{children:(0,W.jsxs)(h.A,{children:[(0,W.jsx)(_.A,{children:"COA"}),(0,W.jsx)(_.A,{children:"Debit"}),(0,W.jsx)(_.A,{children:"Credit"}),(0,W.jsx)(_.A,{children:"Remarks"}),(0,W.jsx)(_.A,{})]})}),(0,W.jsx)(m.A,{children:(q.journal_lines||[]).map((e,t)=>(0,W.jsxs)(h.A,{children:[(0,W.jsx)(_.A,{sx:{minWidth:200},children:(0,W.jsxs)(w.A,{fullWidth:!0,value:String(e.coa_id||""),onChange:e=>{const n=(0,o.A)({},q);n.journal_lines=n.journal_lines||[],n.journal_lines[t]=(0,o.A)((0,o.A)({},n.journal_lines[t]||{}),{},{coa_id:e.target.value}),H(n)},children:[(0,W.jsx)(k.A,{value:"",children:"-- Select COA --"}),E.map(e=>(0,W.jsx)(k.A,{value:String(e.coa_id),children:e.account_name||e.name||e.coa_id},e.coa_id))]})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(g.A,{fullWidth:!0,value:e.debit||"",onChange:e=>{const n=(0,o.A)({},q);n.journal_lines=n.journal_lines||[],n.journal_lines[t]=(0,o.A)((0,o.A)({},n.journal_lines[t]||{}),{},{debit:e.target.value}),H(n)},InputProps:{sx:{textAlign:"right"}}})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(g.A,{fullWidth:!0,value:e.credit||"",onChange:e=>{const n=(0,o.A)({},q);n.journal_lines=n.journal_lines||[],n.journal_lines[t]=(0,o.A)((0,o.A)({},n.journal_lines[t]||{}),{},{credit:e.target.value}),H(n)},InputProps:{sx:{textAlign:"right"}}})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(g.A,{fullWidth:!0,value:e.remarks||"",onChange:e=>{const n=(0,o.A)({},q);n.journal_lines=n.journal_lines||[],n.journal_lines[t]=(0,o.A)((0,o.A)({},n.journal_lines[t]||{}),{},{remarks:e.target.value}),H(n)}})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(c.A,{color:"error",onClick:()=>{const e=(0,o.A)({},q);e.journal_lines=e.journal_lines||[],e.journal_lines=e.journal_lines.filter((e,n)=>n!==t),H(e)},children:"Remove"})})]},t))})]}),(0,W.jsx)(a.A,{sx:{mt:1},children:(0,W.jsx)(c.A,{onClick:()=>{const e=(0,o.A)({},q);e.journal_lines=e.journal_lines||[],e.journal_lines.push({coa_id:"",debit:0,credit:0,remarks:""}),H(e)},children:"+ Add another line"})}),(0,W.jsxs)(a.A,{sx:{mt:2,textAlign:"right"},children:[(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Total Debit"})," PHP ",(q.journal_lines||[]).reduce((e,t)=>e+(Number(t.debit)||0),0)]}),(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Total Credit"})," PHP ",(q.journal_lines||[]).reduce((e,t)=>e+(Number(t.credit)||0),0)]})]})]}),(0,W.jsxs)(a.A,{sx:{mt:2,mb:2},children:[(0,W.jsx)(a.A,{sx:{fontWeight:700,mb:1},children:"SIGNATORIES"}),(0,W.jsxs)(a.A,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:2},children:[(0,W.jsx)(g.A,{label:"Prepared By",value:re(q.prepared_by||q.prepared_by_manual||(null===e||void 0===e?void 0:e.user_id)),disabled:!0}),(0,W.jsx)(g.A,{label:"Reviewed By",value:re(q.reviewed_by||q.reviewed_by_manual||e&&(e.reviewer_id||e.reviewer_manual)),onChange:e=>H((0,o.A)((0,o.A)({},q),{},{reviewed_by:e.target.value}))}),(0,W.jsx)(g.A,{label:"Approved By",value:re(q.approved_by||q.approved_by_manual||e&&(e.approver_id||e.approver_manual)),onChange:e=>H((0,o.A)((0,o.A)({},q),{},{approved_by:e.target.value}))})]})]})]}),(0,W.jsxs)(S.A,{children:[(0,W.jsx)(c.A,{onClick:()=>$(!1),children:"Cancel"}),(0,W.jsx)(c.A,{onClick:async()=>{if(!q.purpose)return he("Purpose is required"),me("error"),void ue(!0);if(!q.payment_lines||0===q.payment_lines.length)return he("At least one payment line is required"),me("error"),void ue(!0);if(!q.journal_lines||q.journal_lines.length<2)return he("At least two journal entry lines are required"),me("error"),void ue(!0);if(!q.reviewed_by||!q.approved_by)return he("Reviewed by and Approved by must be filled"),me("error"),void ue(!0);if((q.journal_lines||[]).reduce((e,t)=>e+(Number(t.debit)||0),0)!==(q.journal_lines||[]).reduce((e,t)=>e+(Number(t.credit)||0),0))return he("Total Debit and Total Credit must be equal"),me("error"),void ue(!0);const t=(q.payment_lines||[]).map(e=>{var t;const n=e.payee_id||e.payee_contact_id||"",r=e.payee_name||e.payee_display||(null===(t=s.find(e=>String(e.contact_id)===String(n)))||void 0===t?void 0:t.display_name)||"";return{payee_contact_id:n?Number(n):null,payee_display:r,description:e.description,amount:Number(e.amount)}}),n=e=>{if(void 0===e||null===e||""===e)return{id:null,manual:null};if(!isNaN(Number(e)))return{id:Number(e),manual:null};try{const t=JSON.parse(e);if(Array.isArray(t)&&t.length&&!isNaN(Number(t[0])))return{id:Number(t[0]),manual:null}}catch(t){}return{id:null,manual:String(e)}},r=n(q.reviewed_by||q.reviewed_by_manual||""),a=n(q.approved_by||q.approved_by_manual||""),i={status:q.status||"Draft",preparation_date:q.preparation_date,purpose:q.purpose,paid_through:q.paid_through||"Bank",prepared_by:(null===e||void 0===e?void 0:e.user_id)||null,description:q.description||"",payment_lines:t,journal_lines:(q.journal_lines||[]).map(e=>({coa_id:e.coa_id||null,debit:Number(e.debit)||0,credit:Number(e.credit)||0,remarks:e.remarks||""})),reviewer_id:r.id,reviewer_manual:r.manual,approver_id:a.id,approver_manual:a.manual};try{const e=localStorage.getItem("token");if(L)await B.A.put((0,D.c$)("/api/payment-vouchers/".concat(L.payment_voucher_id)),i,{headers:{Authorization:"Bearer ".concat(e)}}),he("Payment Voucher updated"),me("success"),ue(!0),$(!1),ye();else{const t=await B.A.post((0,D.c$)("/api/payment-vouchers"),i,{headers:{Authorization:"Bearer ".concat(e)}}),n=t.data&&t.data.payment_voucher_control?t.data.payment_voucher_control:null;he(n?"Payment Voucher created (".concat(n,")"):"Payment Voucher created"),me("success"),ue(!0),$(!1),ye()}}catch(c){var l,o;he((null===(l=c.response)||void 0===l||null===(o=l.data)||void 0===o?void 0:o.error)||c.message||"Save failed"),me("error"),ue(!0)}},variant:"contained",children:"Save"})]})]}),(0,W.jsxs)(v.A,{open:X,onClose:()=>Z(!1),fullWidth:!0,maxWidth:"md",children:[(0,W.jsx)(x.A,{children:"Preview Payment Voucher"}),(0,W.jsx)(j.A,{children:ee?(0,W.jsxs)("div",{id:"pv-print-area",style:{padding:20,fontFamily:"Arial, sans-serif",color:"#000"},children:[(0,W.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[(0,W.jsxs)("div",{children:[(0,W.jsx)("div",{style:{fontSize:20,fontWeight:700},children:(null===Y||void 0===Y?void 0:Y.company_name)||(null===Y||void 0===Y?void 0:Y.name)||"Company Name"}),(0,W.jsx)("div",{style:{fontSize:12},children:(null===Y||void 0===Y?void 0:Y.address)||""})]}),(0,W.jsx)("div",{children:null!==Y&&void 0!==Y&&Y.logo?(0,W.jsx)("img",{src:Y.logo,alt:"logo",style:{height:60}}):null})]}),(0,W.jsx)("hr",{}),(0,W.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:10},children:[(0,W.jsxs)("div",{children:[(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"PV Ctrl:"})," ",ee.payment_voucher_control]}),(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Prepared:"})," ",(0,I.V)(ee.preparation_date)]}),(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Purpose:"})," ",ee.purpose]})]}),(0,W.jsx)("div",{style:{textAlign:"right"},children:(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Amount:"})," PHP ",ee.amount_to_pay||(ee.payment_lines&&ee.payment_lines.length?ee.payment_lines.reduce((e,t)=>e+(Number(t.amount)||0),0):0)]})})]}),(0,W.jsxs)("div",{style:{marginTop:20},children:[(0,W.jsx)("div",{style:{fontWeight:700},children:"Payment Details"}),(0,W.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse",marginTop:8},children:[(0,W.jsx)("thead",{children:(0,W.jsxs)("tr",{children:[(0,W.jsx)("th",{style:{borderBottom:"1px solid #ccc",textAlign:"left"},children:"Payee"}),(0,W.jsx)("th",{style:{borderBottom:"1px solid #ccc",textAlign:"left"},children:"Description"}),(0,W.jsx)("th",{style:{borderBottom:"1px solid #ccc",textAlign:"right"},children:"Amount"})]})}),(0,W.jsx)("tbody",{children:(ee.payment_lines||[]).map((e,t)=>(0,W.jsxs)("tr",{children:[(0,W.jsx)("td",{style:{padding:"6px 0"},children:e.payee_display||e.payee_name||e.payee_contact_id||"-"}),(0,W.jsx)("td",{style:{padding:"6px 0"},children:e.description||""}),(0,W.jsx)("td",{style:{padding:"6px 0",textAlign:"right"},children:Number(e.amount).toFixed(2)})]},t))})]})]}),(0,W.jsxs)("div",{style:{marginTop:20},children:[(0,W.jsx)("div",{style:{fontWeight:700},children:"Journal Entries"}),(0,W.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse",marginTop:8},children:[(0,W.jsx)("thead",{children:(0,W.jsxs)("tr",{children:[(0,W.jsx)("th",{style:{borderBottom:"1px solid #ccc",textAlign:"left"},children:"COA"}),(0,W.jsx)("th",{style:{borderBottom:"1px solid #ccc",textAlign:"right"},children:"Debit"}),(0,W.jsx)("th",{style:{borderBottom:"1px solid #ccc",textAlign:"right"},children:"Credit"})]})}),(0,W.jsx)("tbody",{children:(ee.journal_lines||[]).map((e,t)=>(0,W.jsxs)("tr",{children:[(0,W.jsx)("td",{style:{padding:"6px 0"},children:e.account_name||e.coa_name||""}),(0,W.jsx)("td",{style:{padding:"6px 0",textAlign:"right"},children:Number(e.debit||0).toFixed(2)}),(0,W.jsx)("td",{style:{padding:"6px 0",textAlign:"right"},children:Number(e.credit||0).toFixed(2)})]},t))})]})]}),(0,W.jsx)("div",{style:{marginTop:20},children:(0,W.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,W.jsxs)("div",{style:{textAlign:"center",width:"30%"},children:[(0,W.jsx)("div",{style:{fontWeight:700},children:"Prepared By"}),(0,W.jsx)("div",{style:{marginTop:24},children:"__________________"}),(0,W.jsx)("div",{style:{marginTop:8,fontSize:12},children:ee.prepared_by_name||re(ee.prepared_by||ee.prepared_by_manual||"")})]}),(0,W.jsxs)("div",{style:{textAlign:"center",width:"30%"},children:[(0,W.jsx)("div",{style:{fontWeight:700},children:"Reviewed By"}),(0,W.jsx)("div",{style:{marginTop:24},children:"__________________"}),(0,W.jsx)("div",{style:{marginTop:8,fontSize:12},children:ee.reviewed_by_name||re(ee.reviewed_by||ee.reviewed_by_manual||"")})]}),(0,W.jsxs)("div",{style:{textAlign:"center",width:"30%"},children:[(0,W.jsx)("div",{style:{fontWeight:700},children:"Approved By"}),(0,W.jsx)("div",{style:{marginTop:24},children:"__________________"}),(0,W.jsx)("div",{style:{marginTop:8,fontSize:12},children:ee.approved_by_name||re(ee.approved_by||ee.approved_by_manual||"")})]})]})})]}):(0,W.jsx)("div",{children:"No preview data"})}),(0,W.jsxs)(S.A,{children:[(0,W.jsx)(c.A,{onClick:()=>Z(!1),children:"Close"}),(0,W.jsx)(c.A,{onClick:()=>ee&&(async e=>{if(e)try{const n=localStorage.getItem("token"),r={};n&&(r.Authorization="Bearer ".concat(n));const a=await(0,D.S)("/api/payment-vouchers/".concat(e,"/pdf"),{headers:r});if(!a.ok){const e=await a.text();let n=e;try{n=JSON.parse(e).error||e}catch(t){n=e}return he(n||"PDF request failed: ".concat(a.status)),me("error"),void ue(!0)}if(!(a.headers.get("content-type")||"").includes("application/pdf")){const e=await a.text();let n=e;try{n=JSON.parse(e).error||e}catch(t){n=e}return he(n||"Server did not return a PDF"),me("error"),void ue(!0)}const i=await a.blob(),l=URL.createObjectURL(i),s=a.headers.get("content-disposition")||"";let o="voucher.pdf";const c=/filename="?([^";]+)"?/.exec(s);c&&c[1]&&(o=c[1]);const d=document.createElement("a");d.href=l,d.download=o,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(l)}catch(t){he((null===t||void 0===t?void 0:t.message)||"Download failed"),me("error"),ue(!0)}})(ee.payment_voucher_id),sx:{mr:1},children:"Download PDF"}),(0,W.jsx)(c.A,{onClick:()=>{const e=document.getElementById("pv-print-area");if(!e)return he("Nothing to print"),me("info"),void ue(!0);const t='<!doctype html><html><head><meta charset="utf-8"><title>Payment Voucher</title><style>body{font-family: Arial, sans-serif; color:#000; padding:20px;} table{width:100%;border-collapse:collapse;} th,td{padding:6px 4px;} th{border-bottom:1px solid #ccc;}</style></head><body>'.concat(e.innerHTML,"<script> (function(){ function doPrint(){ try{ window.focus(); window.print(); }catch(e){ console.error('Print failed', e); } } if(document.readyState==='complete'){ setTimeout(doPrint,50); } else { window.addEventListener('load', function(){ setTimeout(doPrint,50); }); } window.addEventListener('afterprint', function(){ try{ window.close(); }catch(e){} }); })(); <\/script></body></html>"),n=window.open("","_blank");if(!n)try{var r;const e=document.createElement("iframe");e.style.position="fixed",e.style.right="0",e.style.bottom="0",e.style.width="0",e.style.height="0",e.style.border="0",document.body.appendChild(e);const n=null===(r=e.contentWindow)||void 0===r?void 0:r.document;if(!n)throw new Error("iframe doc unavailable");n.open(),n.write(t),n.close();const a=()=>{try{var t,n;null===(t=e.contentWindow)||void 0===t||t.focus(),null===(n=e.contentWindow)||void 0===n||n.print()}catch(r){console.error("Iframe print failed",r),he("Print failed in iframe"),me("error"),ue(!0)}setTimeout(()=>{try{document.body.removeChild(e)}catch(r){}},500)};return e.onload=a,void setTimeout(a,800)}catch(a){return console.error("Print fallback failed",a),he("Popup blocked and fallback failed. Allow popups or use Download PDF."),me("error"),void ue(!0)}n.document.open(),n.document.write(t),n.document.close()},variant:"contained",children:"Print / Save as PDF"})]})]}),(0,W.jsxs)(v.A,{open:le,onClose:()=>se(!1),children:[(0,W.jsx)(x.A,{children:"Confirm Delete"}),(0,W.jsx)(j.A,{children:"Are you sure you want to delete this payment voucher?"}),(0,W.jsxs)(S.A,{children:[(0,W.jsx)(c.A,{onClick:()=>se(!1),children:"Cancel"}),(0,W.jsx)(c.A,{color:"error",onClick:async()=>{if(null!=ae)try{const e=localStorage.getItem("token");await B.A.delete((0,D.c$)("/api/payment-vouchers/".concat(ae)),{headers:{Authorization:"Bearer ".concat(e)}}),he("Deleted"),me("success"),ue(!0),se(!1),ie(null),ye()}catch(n){var e,t;he((null===(e=n.response)||void 0===e||null===(t=e.data)||void 0===t?void 0:t.error)||n.message||"Delete failed"),me("error"),ue(!0)}},children:"Delete"})]})]}),(0,W.jsx)(C.A,{open:de,autoHideDuration:4e3,onClose:()=>ue(!1),children:(0,W.jsx)(N.A,{severity:_e,sx:{width:"100%"},children:pe})})]})};function E(){const{data:e,loading:t,error:n,fetchAll:a}=function(e){let{endpoint:t,initialData:n=[]}=e;const[a,i]=(0,r.useState)(n),[l,s]=(0,r.useState)(!1),[o,c]=(0,r.useState)(null);console.debug&&console.debug("useCrud: resolved API_BASE =",D.tE||"(empty, using fallback)");const d=e=>(0,D.c$)(e.startsWith("/")?e:"/"+e),u=(0,r.useCallback)(async()=>{s(!0),c(null);try{const e=d(t),n=await B.A.get(e);i(n.data)}catch(r){var e,n;c((null===(e=r.response)||void 0===e||null===(n=e.data)||void 0===n?void 0:n.message)||r.message)}finally{s(!1)}},[t]),p=(0,r.useCallback)(async e=>{s(!0),c(null);try{const n=d(t);await B.A.post(n,e),await u()}catch(a){var n,r;c((null===(n=a.response)||void 0===n||null===(r=n.data)||void 0===r?void 0:r.message)||a.message)}finally{s(!1)}},[t,u]),h=(0,r.useCallback)(async(e,n)=>{s(!0),c(null);try{const r=d("".concat(t,"/").concat(e));await B.A.put(r,n),await u()}catch(i){var r,a;c((null===(r=i.response)||void 0===r||null===(a=r.data)||void 0===a?void 0:a.message)||i.message)}finally{s(!1)}},[t,u]),_=(0,r.useCallback)(async e=>{s(!0),c(null);try{const n=d("".concat(t,"/").concat(e));await B.A.delete(n),await u()}catch(a){var n,r;c((null===(n=a.response)||void 0===n||null===(r=n.data)||void 0===r?void 0:r.message)||a.message)}finally{s(!1)}},[t,u]);return{data:a,loading:l,error:o,fetchAll:u,add:p,update:h,remove:_,setData:i}}({endpoint:"/api/disbursement-reports"}),[i,l]=(0,r.useState)({}),[s,u]=(0,r.useState)([]),[p,h]=(0,r.useState)({}),[_,m]=(0,r.useState)(!1);(0,r.useEffect)(()=>{B.A.get((0,D.c$)("/api/payment-vouchers")).then(e=>u(e.data)).catch(()=>{})},[]),r.useEffect(()=>{a()},[a]);const[y,A]=(0,r.useState)(!1),[g,b]=(0,r.useState)(""),[f,w]=(0,r.useState)("info"),[k,P]=(0,r.useState)(!1),[T,z]=(0,r.useState)(null),[R,E]=(0,r.useState)(null),[V,O]=(0,r.useState)(!1),[$,L]=(0,r.useState)(!1);return t?(0,W.jsx)("div",{children:"Loading..."}):n?(0,W.jsx)("div",{children:"Error loading reports"}):(0,W.jsxs)("div",{children:[(0,W.jsx)("h2",{children:"Disbursement Reports"}),(0,W.jsx)("button",{onClick:()=>a(),children:"Refresh"}),(0,W.jsxs)("div",{style:{display:"flex",gap:"2rem"},children:[(0,W.jsxs)("div",{style:{flex:1},children:[(0,W.jsx)("h3",{children:"Available Payment Vouchers"}),(0,W.jsxs)("div",{children:[(0,W.jsx)("button",{onClick:()=>h({}),children:"Clear"}),(0,W.jsx)("button",{onClick:()=>B.A.get((0,D.c$)("/api/payment-vouchers")).then(e=>u(e.data)).catch(()=>{}),children:"Refresh"})]}),(0,W.jsx)("ul",{children:s.map(e=>(0,W.jsxs)("li",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[(0,W.jsx)("input",{type:"checkbox",checked:!!p[e.payment_voucher_id],onChange:()=>h(t=>(0,o.A)((0,o.A)({},t),{},{[e.payment_voucher_id]:!t[e.payment_voucher_id]}))}),(0,W.jsxs)("div",{children:[e.payment_voucher_control," \u2014 ",e.payee_name||e.payment_lines&&e.payment_lines[0]&&(e.payment_lines[0].payee_display||e.payment_lines[0].payee_contact_id)||""," \u2014 ",e.amount_to_pay||(e.payment_lines&&e.payment_lines.length?e.payment_lines.reduce((e,t)=>e+(Number(t.amount)||0),0):0)]})]},e.payment_voucher_id))}),(0,W.jsx)("div",{children:(0,W.jsx)("button",{disabled:_,onClick:async()=>{const e=Object.keys(p).filter(e=>p[+e]).map(e=>+e);if(0===e.length)return b("Select at least one PV"),w("info"),void A(!0);const t=s.filter(t=>e.includes(t.payment_voucher_id)).reduce((e,t)=>e+(Number(t.amount_to_pay)||(t.payment_lines&&t.payment_lines.length?t.payment_lines.reduce((e,t)=>e+(Number(t.amount)||0),0):0)),0);m(!0);try{const n=localStorage.getItem("token");await B.A.post((0,D.c$)("/api/disbursement-reports"),{status:"Draft",disbursement_date:(new Date).toISOString().slice(0,10),purpose:"Bulk created from UI",amount_to_pay:t,paid_through:"Bank",voucher_ids:e},{headers:{Authorization:"Bearer ".concat(n)}}),b("Disbursement Report created"),w("success"),A(!0),a(),h({})}catch(i){var n,r;b((null===(n=i.response)||void 0===n||null===(r=n.data)||void 0===r?void 0:r.error)||i.message||"Create failed"),w("error"),A(!0)}finally{m(!1)}},children:_?(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(d.A,{size:16})," Creating..."]}):"Create DR from selected"})})]}),(0,W.jsxs)("div",{style:{flex:2},children:[(0,W.jsx)("h2",{children:"Disbursement Reports"}),(0,W.jsx)("button",{onClick:()=>a(),children:"Refresh"}),(0,W.jsx)("ul",{children:e&&e.map(e=>(0,W.jsxs)("li",{style:{marginBottom:"1rem"},children:[(0,W.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:e.disbursement_report_ctrl_number})," \u2014 ",(0,I.V)(e.disbursement_date)," \u2014 ",e.status]}),(0,W.jsxs)("div",{children:[(0,W.jsxs)("button",{onClick:()=>l(t=>(0,o.A)((0,o.A)({},t),{},{[e.disbursement_report_id]:!t[e.disbursement_report_id]})),children:[i[e.disbursement_report_id]?"Hide":"Show"," Vouchers"]}),(0,W.jsx)("button",{style:{marginLeft:8},onClick:async()=>{try{const t=await B.A.get("/api/disbursement-reports/".concat(e.disbursement_report_id));z(t.data);const n=await B.A.post("/api/disbursement-reports/".concat(e.disbursement_report_id,"/submit"),{cascade:!1},{headers:{Authorization:"Bearer ".concat(localStorage.getItem("token"))}}).then(e=>e.data);E(n.routing||null),P(!0)}catch(r){var t,n;b((null===(t=r.response)||void 0===t||null===(n=t.data)||void 0===n?void 0:n.error)||r.message||"Routing preview failed"),w("error"),A(!0)}},children:"Submit for Approval"})]})]}),i[e.disbursement_report_id]&&(0,W.jsx)("div",{style:{paddingLeft:"1rem",marginTop:"0.5rem"},children:e.vouchers&&e.vouchers.length>0?(0,W.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse"},children:[(0,W.jsx)("thead",{children:(0,W.jsxs)("tr",{children:[(0,W.jsx)("th",{children:"PV Ctrl"}),(0,W.jsx)("th",{children:"Payee"}),(0,W.jsx)("th",{children:"Amount"}),(0,W.jsx)("th",{children:"Date"})]})}),(0,W.jsx)("tbody",{children:e.vouchers.map(e=>(0,W.jsxs)("tr",{children:[(0,W.jsx)("td",{children:e.payment_voucher_control}),(0,W.jsx)("td",{children:e.payee_name||e.payment_lines&&e.payment_lines[0]&&(e.payment_lines[0].payee_display||e.payment_lines[0].payee_contact_id)||""}),(0,W.jsx)("td",{children:e.amount_to_pay||(e.payment_lines&&e.payment_lines.length?e.payment_lines.reduce((e,t)=>e+(Number(t.amount)||0),0):0)}),(0,W.jsx)("td",{children:(0,I.V)(e.preparation_date)})]},e.payment_voucher_id))})]}):(0,W.jsx)("div",{children:"No vouchers"})})]},e.disbursement_report_id))})]})]}),(0,W.jsx)(C.A,{open:y,autoHideDuration:4e3,onClose:()=>A(!1),children:(0,W.jsx)(N.A,{severity:f,sx:{width:"100%"},children:g})}),(0,W.jsxs)(v.A,{open:k,onClose:()=>P(!1),maxWidth:"sm",fullWidth:!0,children:[(0,W.jsx)(x.A,{children:"Submit Disbursement Report for Approval"}),(0,W.jsx)(j.A,{children:R?(0,W.jsxs)("div",{children:[(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Reviewer:"})," ",R.reviewer?R.reviewer.id||R.reviewer.manual:"None"]}),(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Approver:"})," ",R.approver?R.approver.id||R.approver.manual:"None"]}),(0,W.jsx)("div",{style:{marginTop:8},children:(0,W.jsxs)("label",{children:[(0,W.jsx)("input",{type:"checkbox",checked:$,onChange:e=>L(e.target.checked)})," Cascade immediately if approver present"]})}),R.notes&&R.notes.length>0&&(0,W.jsxs)("div",{style:{marginTop:8},children:[(0,W.jsx)("strong",{children:"Notes:"}),(0,W.jsx)("ul",{children:R.notes.map((e,t)=>(0,W.jsx)("li",{children:e},t))})]})]}):(0,W.jsx)("div",{children:"Loading routing info..."})}),(0,W.jsxs)(S.A,{children:[(0,W.jsx)(c.A,{onClick:()=>P(!1),children:"Cancel"}),(0,W.jsx)(c.A,{color:"primary",variant:"contained",disabled:V,onClick:async()=>{if(T){O(!0);try{const e=await B.A.post("/api/disbursement-reports/".concat(T.disbursement_report_id,"/submit"),{cascade:$},{headers:{Authorization:"Bearer ".concat(localStorage.getItem("token"))}});b(e.data.message||"Submitted"),w("success"),A(!0),P(!1),a()}catch(n){var e,t;b((null===(e=n.response)||void 0===e||null===(t=e.data)||void 0===t?void 0:t.error)||n.message||"Submit failed"),w("error"),A(!0)}finally{O(!1)}}},children:"Submit"})]})]})]})}console.debug&&console.debug("DisbursementReports: resolved API_BASE =",D.tE||"(empty, using fallback)");var V=n(8903),O=n(5865),$=n(9336),L=n(8357);const F=()=>{const[e,t]=(0,r.useState)([]),[n,l]=(0,r.useState)([]),[s,d]=(0,r.useState)([]),[y,b]=(0,r.useState)(!1),[f,T]=(0,r.useState)(null),[z,R]=(0,r.useState)({}),E=(0,r.useRef)(null),[F,q]=(0,r.useState)(!1),[H,J]=(0,r.useState)(""),[U,M]=(0,r.useState)("info"),[Y,G]=(0,r.useState)({}),[K,Q]=(0,r.useState)([]),X=async()=>{try{const e=await(0,D.S)("/api/check-vouchers");e.ok?t(await e.json()):t([])}catch(e){t([])}};(0,r.useEffect)(()=>{X()},[]);const Z=async()=>{try{const e=await B.A.get((0,D.c$)("/api/contacts"));return l(Array.isArray(e.data)?e.data:[]),e.data}catch(e){return l([]),[]}},ee=async()=>{try{const e=await B.A.get((0,D.c$)("/api/coa/all/simple"));return d(Array.isArray(e.data)?e.data:[]),e.data}catch(e){return d([]),[]}},te=async()=>{try{const e=await B.A.get((0,D.c$)("/api/users/public"));Q(Array.isArray(e.data)?e.data:[]);const t={};for(const n of e.data||[])n&&n.user_id&&(t[String(n.user_id)]=n.full_name||n.username||String(n.user_id));return G(e=>(0,o.A)((0,o.A)({},t),e)),e.data}catch(e){return[]}},ne=e=>{if(void 0===e||null===e||""===e)return[];if(Array.isArray(e))return e.map(String).filter(Boolean);if("number"===typeof e)return[String(e)];if("string"===typeof e){try{const t=JSON.parse(e);if(Array.isArray(t))return t.map(String).filter(Boolean);if("number"===typeof t||"string"===typeof t)return[String(t)]}catch(t){}const n=e.match(/\d+/);return n?[n[0]]:[]}return[]},re=e=>{const t=ne(e);return t.length?t.map(e=>Y[String(e)]||String(e)).join(", "):e&&"string"===typeof e?e:""},ae=()=>{R({}),T(null),b(!1)},[ie,le]=(0,r.useState)(!1),[se,oe]=(0,r.useState)(null);return(0,W.jsxs)(a.A,{children:[(0,W.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,W.jsx)("h3",{children:"Check Vouchers"}),(0,W.jsxs)("div",{children:[(0,W.jsx)(c.A,{variant:"contained",onClick:async()=>{await Promise.all([Z(),ee(),te()]),T(null);let e=null,t=null,n=null;try{const i=localStorage.getItem("token"),l=await B.A.get((0,D.c$)("/api/auth/me"),{headers:i?{Authorization:"Bearer ".concat(i)}:{}});if(l&&l.data&&l.data.user_id){e=l.data.user_id,G(e=>(0,o.A)((0,o.A)({},e),{},{[String(l.data.user_id)]:l.data.full_name||l.data.username||String(l.data.user_id)})),l.data.reviewer_id?t=l.data.reviewer_id:l.data.reviewer_manual&&(t=l.data.reviewer_manual),l.data.approver_id?n=l.data.approver_id:l.data.approver_manual&&(n=l.data.approver_manual);try{const e=[];t&&!isNaN(Number(t))&&e.push(String(t)),n&&!isNaN(Number(n))&&e.push(String(n));for(const t of Array.from(new Set(e)))if(!Y[t])try{const e=await B.A.get((0,D.c$)("/api/users/".concat(t)),{headers:i?{Authorization:"Bearer ".concat(i)}:{}});e&&e.data&&G(n=>(0,o.A)((0,o.A)({},n),{},{[t]:e.data.full_name||e.data.username||t}))}catch(r){}}catch(a){}}}catch(r){}R({cvoucher_date:(new Date).toISOString().slice(0,10),purpose:"",payment_lines:[{payee_contact_id:null,payee_display:"",description:"",amount:0}],journal_lines:[{coa_id:"",debit:0,credit:0,remarks:""},{coa_id:"",debit:0,credit:0,remarks:""}],mode:"single",check_lines:[],prepared_by:e,reviewed_by:t,approved_by:n,paid_through:"Bank",status:"Draft"}),b(!0),setTimeout(()=>{try{var e;null===(e=E.current)||void 0===e||e.focus()}catch(r){}},0)},sx:{mr:1},children:"New CV"}),(0,W.jsx)(c.A,{onClick:()=>X(),sx:{mr:1},children:"Refresh"})]})]}),(0,W.jsx)(V.Ay,{container:!0,spacing:2,children:(0,W.jsx)(V.Ay,{item:!0,xs:12,md:6,children:(0,W.jsxs)(i.A,{sx:{p:2},children:[(0,W.jsx)(O.A,{variant:"h6",children:"Existing Check Vouchers"}),(0,W.jsx)($.A,{sx:{my:1}}),(0,W.jsx)(a.A,{children:(0,W.jsxs)("ul",{children:[e.map(e=>(0,W.jsxs)("li",{style:{marginBottom:6},children:[(0,W.jsx)("strong",{children:e.check_voucher_control})," \u2014 ",e.check_payee||e.payment_lines&&e.payment_lines[0]&&(e.payment_lines[0].payee_display||e.payment_lines[0].payee_name)||""," \u2014 PHP ",e.check_amount||(e.payment_lines&&e.payment_lines.length?e.payment_lines.reduce((e,t)=>e+(Number(t.amount)||0),0):0),(0,W.jsxs)("div",{style:{marginTop:4},children:[(0,W.jsx)(c.A,{size:"small",onClick:()=>(async e=>{var t,n,r,a,i,l,s,c,d,u,p,h,_,m;await Promise.all([Z(),ee(),te()]),T(e);let y=null;try{const e=localStorage.getItem("token"),t=await B.A.get((0,D.c$)("/api/auth/me"),{headers:e?{Authorization:"Bearer ".concat(e)}:{}});t&&t.data&&(y=t.data)}catch(g){}const v=null!==(t=null!==(n=null!==(r=null!==(a=null!==(i=e.reviewer_id)&&void 0!==i?i:e.reviewed_by)&&void 0!==a?a:e.reviewer_manual)&&void 0!==r?r:e.reviewed_by_manual)&&void 0!==n?n:null)&&void 0!==t?t:null,x=null!==(l=null!==(s=null!==(c=null!==(d=null!==(u=e.approver_id)&&void 0!==u?u:e.approved_by)&&void 0!==d?d:e.approver_manual)&&void 0!==c?c:e.approved_by_manual)&&void 0!==s?s:null)&&void 0!==l?l:null,A=null!=v&&""!==v?v:y&&null!==(p=null!==(h=y.reviewer_id)&&void 0!==h?h:y.reviewer_manual)&&void 0!==p?p:null,j=null!=x&&""!==x?x:y&&null!==(_=null!==(m=y.approver_id)&&void 0!==m?m:y.approver_manual)&&void 0!==_?_:null;R((0,o.A)((0,o.A)({},e),{},{cvoucher_date:e.cvoucher_date&&"string"===typeof e.cvoucher_date&&-1!==e.cvoucher_date.indexOf("T")?e.cvoucher_date.slice(0,10):e.cvoucher_date,payment_lines:e.payment_lines&&e.payment_lines.length?e.payment_lines.map(e=>({payee_contact_id:e.payee_contact_id,payee_display:e.payee_display,description:e.description,amount:e.amount})):[{payee_contact_id:null,payee_display:"",description:"",amount:0}],journal_lines:e.journal_lines&&e.journal_lines.length?e.journal_lines.map(e=>({coa_id:e.coa_id,debit:e.debit,credit:e.credit,remarks:e.remarks})):[{coa_id:"",debit:0,credit:0,remarks:""},{coa_id:"",debit:0,credit:0,remarks:""}],mode:e.multiple_checks?"multi":"single",check_lines:e.check_lines&&e.check_lines.length?e.check_lines.map(e=>({check_date:e.check_date,check_number:e.check_number,check_amount:e.check_amount,check_subpayee:e.check_subpayee})):[],reviewed_by:A,approved_by:j})),b(!0);try{const t=localStorage.getItem("token"),n=[],r=e=>void 0!==e&&null!==e?e:"",a=[r(e.prepared_by),r(e.prepared_by_manual),r(A),r(e.reviewed_by_manual),r(j),r(e.approved_by_manual)];for(const e of a)e&&!isNaN(Number(e))&&n.push(String(e));for(const e of Array.from(new Set(n)))if(!Y[e])try{const n=await B.A.get((0,D.c$)("/api/users/".concat(e)),{headers:t?{Authorization:"Bearer ".concat(t)}:{}});n&&n.data&&G(t=>(0,o.A)((0,o.A)({},t),{},{[e]:n.data.full_name||n.data.username||e}))}catch(f){}}catch(f){}})(e),sx:{mr:1},children:"Edit"}),(0,W.jsx)(c.A,{size:"small",onClick:async()=>{try{const n=localStorage.getItem("token"),r=await B.A.get((0,D.c$)("/api/check-vouchers/".concat(e.check_voucher_id)),{headers:n?{Authorization:"Bearer ".concat(n)}:{}}),a=r&&r.data?r.data:e,i=(0,o.A)({},a);if(!i.company)try{const e=await(0,D.S)("/api/company-profile",{cache:"no-store"});e.ok&&(i.company=await e.json())}catch(t){}const l={},s=e=>void 0!==e&&null!==e?e:"",c=[],d=e=>{const t=ne(e);t&&t.length&&c.push(...t)};d(s(i.prepared_by)||s(i.prepared_by_manual)),d(s(i.reviewed_by)||s(i.reviewer_id)||s(i.reviewed_by_manual)||s(i.reviewer_manual)),d(s(i.approved_by)||s(i.approver_id)||s(i.approved_by_manual)||s(i.approver_manual));const u=Array.from(new Set(c.filter(e=>e&&!Y[e])));if(u.length&&(await Promise.all(u.map(async e=>{try{const t=await B.A.get((0,D.c$)("/api/users/".concat(e)),{headers:n?{Authorization:"Bearer ".concat(n)}:{}});t&&t.data&&(l[e]=t.data.full_name||t.data.username||e)}catch(t){}})),Object.keys(l).length&&G(e=>(0,o.A)((0,o.A)({},e),l))),!i.prepared_by_name){const e=ne(i.prepared_by||i.prepared_by_manual||"");i.prepared_by_name=e[0]&&(Y[e[0]]||l[e[0]])||i.prepared_by_manual||""}if(!i.reviewed_by_name){const e=ne(i.reviewed_by||i.reviewer_id||i.reviewed_by_manual||i.reviewer_manual||"");i.reviewed_by_name=e[0]&&(Y[e[0]]||l[e[0]])||i.reviewed_by_manual||i.reviewer_manual||""}if(!i.approved_by_name){const e=ne(i.approved_by||i.approver_id||i.approved_by_manual||i.approver_manual||"");i.approved_by_name=e[0]&&(Y[e[0]]||l[e[0]])||i.approved_by_manual||i.approver_manual||""}if(!i.prepared_by_name||!i.reviewed_by_name||!i.approved_by_name)try{const e=await B.A.get((0,D.c$)("/api/auth/me"),{headers:n?{Authorization:"Bearer ".concat(n)}:{}}),t=e&&e.data?e.data:null;if(t){i.prepared_by_name||(i.prepared_by_name=t.full_name||t.username||"");const e=async e=>{if(e&&!isNaN(Number(e))){const r=String(e);if(Y[r])return Y[r];try{const e=await B.A.get((0,D.c$)("/api/users/".concat(r)),{headers:n?{Authorization:"Bearer ".concat(n)}:{}});return e&&e.data&&(e.data.full_name||e.data.username)||r}catch(t){return r}}return String(e||"")};if(!i.reviewed_by_name){const n=t.reviewer_id||t.reviewer_manual||"";i.reviewed_by_name=await e(n)}if(!i.approved_by_name){const n=t.approver_id||t.approver_manual||"";i.approved_by_name=await e(n)}}}catch(t){}oe(i)}catch(n){oe(e)}le(!0)},children:"Preview"})]})]},e.check_voucher_id)),0===e.length&&(0,W.jsx)("li",{children:"No check vouchers found."})]})})]})})}),(0,W.jsxs)(v.A,{open:y,onClose:()=>b(!1),fullWidth:!0,maxWidth:"lg",children:[(0,W.jsxs)(x.A,{children:[f?"Edit Check Voucher (".concat(f&&f.check_voucher_control||"",")"):"New Check Voucher",(0,W.jsx)(A.A,{"aria-label":"close",onClick:()=>b(!1),sx:{position:"absolute",right:8,top:8},children:(0,W.jsx)(P.A,{})})]}),(0,W.jsxs)(j.A,{children:[(0,W.jsxs)(a.A,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:2,mb:2},children:[(0,W.jsx)(g.A,{inputRef:E,label:"Check Date",type:"date",value:z.cvoucher_date||"",onChange:e=>R((0,o.A)((0,o.A)({},z),{},{cvoucher_date:e.target.value})),InputLabelProps:{shrink:!0}}),(0,W.jsx)(g.A,{label:"Purpose",value:z.purpose||"",onChange:e=>R((0,o.A)((0,o.A)({},z),{},{purpose:e.target.value}))})]}),"multi"!==z.mode&&(0,W.jsx)(a.A,{sx:{mb:2},children:(0,W.jsx)(g.A,{label:"Check Number",value:z.check_no||"",onChange:e=>R((0,o.A)((0,o.A)({},z),{},{check_no:e.target.value}))})}),(0,W.jsx)(a.A,{sx:{my:1},children:(0,W.jsxs)(a.A,{children:[(0,W.jsxs)("label",{style:{marginRight:12},children:[(0,W.jsx)("input",{type:"radio",name:"mode",checked:"multi"!==z.mode,onChange:()=>R((0,o.A)((0,o.A)({},z),{},{mode:"single"}))})," Single Check Voucher"]}),(0,W.jsxs)("label",{children:[(0,W.jsx)("input",{type:"radio",name:"mode",checked:"multi"===z.mode,onChange:()=>R((0,o.A)((0,o.A)({},z),{},{mode:"multi"}))})," Multi-Check Voucher"]})]})}),"multi"===z.mode&&(0,W.jsxs)(a.A,{sx:{mt:2,mb:2},children:[(0,W.jsx)(O.A,{variant:"subtitle1",children:"Check Lines"}),(0,W.jsxs)(u.A,{size:"small",children:[(0,W.jsx)(p.A,{children:(0,W.jsxs)(h.A,{children:[(0,W.jsx)(_.A,{children:"Check Date"}),(0,W.jsx)(_.A,{children:"Check No"}),(0,W.jsx)(_.A,{children:"Payee"}),(0,W.jsx)(_.A,{align:"right",children:"Amount"}),(0,W.jsx)(_.A,{})]})}),(0,W.jsx)(m.A,{children:(z.check_lines||[]).map((e,t)=>(0,W.jsxs)(h.A,{children:[(0,W.jsx)(_.A,{children:(0,W.jsx)(g.A,{type:"date",value:e.check_date||"",onChange:e=>{const n=(0,o.A)({},z);n.check_lines=n.check_lines||[],n.check_lines[t]=(0,o.A)((0,o.A)({},n.check_lines[t]||{}),{},{check_date:e.target.value}),R(n)},InputLabelProps:{shrink:!0}})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(g.A,{value:e.check_number||"",onChange:e=>{const n=(0,o.A)({},z);n.check_lines=n.check_lines||[],n.check_lines[t]=(0,o.A)((0,o.A)({},n.check_lines[t]||{}),{},{check_number:e.target.value}),R(n)}})}),(0,W.jsx)(_.A,{children:(0,W.jsxs)(w.A,{fullWidth:!0,value:String(e.check_subpayee||""),onChange:e=>{const n=(0,o.A)({},z);n.check_lines=n.check_lines||[],n.check_lines[t]=(0,o.A)((0,o.A)({},n.check_lines[t]||{}),{},{check_subpayee:e.target.value?Number(e.target.value):null}),R(n)},children:[(0,W.jsx)(k.A,{value:"",children:"(Select contact)"}),n.map(e=>(0,W.jsx)(k.A,{value:e.contact_id,children:e.display_name},e.contact_id))]})}),(0,W.jsx)(_.A,{align:"right",children:(0,W.jsx)(g.A,{type:"number",value:e.check_amount||"",onChange:e=>{const n=(0,o.A)({},z);n.check_lines=n.check_lines||[],n.check_lines[t]=(0,o.A)((0,o.A)({},n.check_lines[t]||{}),{},{check_amount:""===e.target.value?"":Number(e.target.value)}),R(n)},InputProps:{sx:{textAlign:"right"}}})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(c.A,{color:"error",onClick:()=>{const e=(0,o.A)({},z);e.check_lines=e.check_lines||[],e.check_lines=e.check_lines.filter((e,n)=>n!==t),R(e)},children:"Remove"})})]},t))})]}),(0,W.jsx)(a.A,{sx:{mt:1},children:(0,W.jsx)(c.A,{onClick:()=>{const e=(0,o.A)({},z);e.check_lines=e.check_lines||[],e.check_lines.push({check_date:"",check_number:"",check_amount:0,check_subpayee:null}),R(e)},children:"Add Check Line"})})]}),(0,W.jsxs)(a.A,{sx:{mt:2,mb:2},children:[(0,W.jsx)(a.A,{sx:{fontWeight:700,mb:1},children:"PAYMENT DETAILS"}),(0,W.jsxs)(u.A,{size:"small",children:[(0,W.jsx)(p.A,{children:(0,W.jsxs)(h.A,{children:[(0,W.jsx)(_.A,{children:"Payee"}),(0,W.jsx)(_.A,{children:"Description"}),(0,W.jsx)(_.A,{align:"right",children:"Amount to Pay"}),(0,W.jsx)(_.A,{})]})}),(0,W.jsx)(m.A,{children:(z.payment_lines||[]).map((e,t)=>(0,W.jsxs)(h.A,{children:[(0,W.jsx)(_.A,{sx:{minWidth:200},children:(0,W.jsxs)(w.A,{fullWidth:!0,value:String(e.payee_contact_id||""),onChange:e=>{var r;const a=e.target.value,i=(0,o.A)({},z);i.payment_lines=i.payment_lines||[],i.payment_lines[t]=(0,o.A)((0,o.A)({},i.payment_lines[t]||{}),{},{payee_contact_id:a?Number(a):null,payee_display:(null===(r=n.find(e=>String(e.contact_id)===String(a)))||void 0===r?void 0:r.display_name)||""}),R(i)},children:[(0,W.jsx)(k.A,{value:"",children:"-- Select Payee --"}),n.map(e=>(0,W.jsxs)(k.A,{value:String(e.contact_id),children:[e.display_name,e.contact_type?" (".concat(e.contact_type,")"):""]},e.contact_id))]})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(g.A,{fullWidth:!0,value:e.description||"",onChange:e=>{const n=(0,o.A)({},z);n.payment_lines=n.payment_lines||[],n.payment_lines[t]=(0,o.A)((0,o.A)({},n.payment_lines[t]||{}),{},{description:e.target.value}),R(n)}})}),(0,W.jsx)(_.A,{align:"right",children:(0,W.jsx)(g.A,{type:"number",value:e.amount||"",onChange:e=>{const n=(0,o.A)({},z);n.payment_lines=n.payment_lines||[],n.payment_lines[t]=(0,o.A)((0,o.A)({},n.payment_lines[t]||{}),{},{amount:e.target.value}),R(n)},InputProps:{sx:{textAlign:"right"}}})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(c.A,{color:"error",onClick:()=>{const e=(0,o.A)({},z);e.payment_lines=e.payment_lines||[],e.payment_lines=e.payment_lines.filter((e,n)=>n!==t),R(e)},children:"Remove"})})]},t))})]}),(0,W.jsx)(a.A,{sx:{mt:1},children:(0,W.jsx)(c.A,{onClick:()=>{const e=(0,o.A)({},z);e.payment_lines=e.payment_lines||[],e.payment_lines.push({payee_contact_id:null,payee_display:"",description:"",amount:0}),R(e)},children:"+ Add another line"})}),(0,W.jsxs)(a.A,{sx:{mt:2,textAlign:"right",fontWeight:700},children:["Total Amount to Pay: PHP ",(z.payment_lines||[]).reduce((e,t)=>e+(Number(t.amount)||0),0)]})]}),(0,W.jsxs)(a.A,{sx:{mt:2,mb:2},children:[(0,W.jsx)(a.A,{sx:{fontWeight:700,mb:1},children:"JOURNAL ENTRY"}),(0,W.jsxs)(u.A,{size:"small",children:[(0,W.jsx)(p.A,{children:(0,W.jsxs)(h.A,{children:[(0,W.jsx)(_.A,{children:"COA"}),(0,W.jsx)(_.A,{children:"Debit"}),(0,W.jsx)(_.A,{children:"Credit"}),(0,W.jsx)(_.A,{children:"Remarks"}),(0,W.jsx)(_.A,{})]})}),(0,W.jsx)(m.A,{children:(z.journal_lines||[]).map((e,t)=>(0,W.jsxs)(h.A,{children:[(0,W.jsx)(_.A,{sx:{minWidth:200},children:(0,W.jsxs)(w.A,{fullWidth:!0,value:String(e.coa_id||""),onChange:e=>{const n=(0,o.A)({},z);n.journal_lines=n.journal_lines||[],n.journal_lines[t]=(0,o.A)((0,o.A)({},n.journal_lines[t]||{}),{},{coa_id:e.target.value}),R(n)},children:[(0,W.jsx)(k.A,{value:"",children:"-- Select COA --"}),s.map(e=>(0,W.jsx)(k.A,{value:String(e.coa_id),children:e.account_name||e.name||e.coa_id},e.coa_id))]})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(g.A,{fullWidth:!0,value:e.debit||"",onChange:e=>{const n=(0,o.A)({},z);n.journal_lines=n.journal_lines||[],n.journal_lines[t]=(0,o.A)((0,o.A)({},n.journal_lines[t]||{}),{},{debit:e.target.value}),R(n)},InputProps:{sx:{textAlign:"right"}}})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(g.A,{fullWidth:!0,value:e.credit||"",onChange:e=>{const n=(0,o.A)({},z);n.journal_lines=n.journal_lines||[],n.journal_lines[t]=(0,o.A)((0,o.A)({},n.journal_lines[t]||{}),{},{credit:e.target.value}),R(n)},InputProps:{sx:{textAlign:"right"}}})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(g.A,{fullWidth:!0,value:e.remarks||"",onChange:e=>{const n=(0,o.A)({},z);n.journal_lines=n.journal_lines||[],n.journal_lines[t]=(0,o.A)((0,o.A)({},n.journal_lines[t]||{}),{},{remarks:e.target.value}),R(n)}})}),(0,W.jsx)(_.A,{children:(0,W.jsx)(c.A,{color:"error",onClick:()=>{const e=(0,o.A)({},z);e.journal_lines=e.journal_lines||[],e.journal_lines=e.journal_lines.filter((e,n)=>n!==t),R(e)},children:"Remove"})})]},t))})]}),(0,W.jsx)(a.A,{sx:{mt:1},children:(0,W.jsx)(c.A,{onClick:()=>{const e=(0,o.A)({},z);e.journal_lines=e.journal_lines||[],e.journal_lines.push({coa_id:"",debit:0,credit:0,remarks:""}),R(e)},children:"+ Add another line"})}),(0,W.jsxs)(a.A,{sx:{mt:2,textAlign:"right"},children:[(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Total Debit"})," PHP ",(z.journal_lines||[]).reduce((e,t)=>e+(Number(t.debit)||0),0)]}),(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Total Credit"})," PHP ",(z.journal_lines||[]).reduce((e,t)=>e+(Number(t.credit)||0),0)]})]})]}),(0,W.jsxs)(a.A,{sx:{mt:2,mb:2},children:[(0,W.jsx)(a.A,{sx:{fontWeight:700,mb:1},children:"SIGNATORIES"}),(0,W.jsxs)(a.A,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:2},children:[(0,W.jsx)(g.A,{label:"Prepared By",value:z.prepared_by_manual&&z.prepared_by_manual||z.prepared_by&&Y[String(z.prepared_by)]||"",disabled:!0}),(0,W.jsx)(L.A,{freeSolo:!0,options:K.map(e=>({id:e.user_id,label:e.full_name||e.username||String(e.user_id)})),getOptionLabel:e=>"string"===typeof e?e:e&&e.label||"",value:(()=>{const e=z.reviewed_by;return null===e||void 0===e||""===e?"":isNaN(Number(e))?e:Y[String(e)]||String(e)})(),inputValue:(()=>{const e=z.reviewed_by;return null===e||void 0===e||""===e?"":isNaN(Number(e))?e:Y[String(e)]||String(e)})(),onInputChange:(e,t)=>{R(e=>(0,o.A)((0,o.A)({},e),{},{reviewed_by:t}))},onChange:(e,t)=>R(t?"string"===typeof t?e=>(0,o.A)((0,o.A)({},e),{},{reviewed_by:t}):e=>(0,o.A)((0,o.A)({},e),{},{reviewed_by:t.id}):e=>(0,o.A)((0,o.A)({},e),{},{reviewed_by:null})),renderInput:e=>(0,W.jsx)(g.A,(0,o.A)((0,o.A)({},e),{},{label:"Reviewed By"}))}),(0,W.jsx)(L.A,{freeSolo:!0,options:K.map(e=>({id:e.user_id,label:e.full_name||e.username||String(e.user_id)})),getOptionLabel:e=>"string"===typeof e?e:e&&e.label||"",value:(()=>{const e=z.approved_by;return null===e||void 0===e||""===e?"":isNaN(Number(e))?e:Y[String(e)]||String(e)})(),inputValue:(()=>{const e=z.approved_by;return null===e||void 0===e||""===e?"":isNaN(Number(e))?e:Y[String(e)]||String(e)})(),onInputChange:(e,t)=>{R(e=>(0,o.A)((0,o.A)({},e),{},{approved_by:t}))},onChange:(e,t)=>R(t?"string"===typeof t?e=>(0,o.A)((0,o.A)({},e),{},{approved_by:t}):e=>(0,o.A)((0,o.A)({},e),{},{approved_by:t.id}):e=>(0,o.A)((0,o.A)({},e),{},{approved_by:null})),renderInput:e=>(0,W.jsx)(g.A,(0,o.A)((0,o.A)({},e),{},{label:"Approved By"}))})]})]})]}),(0,W.jsxs)(S.A,{children:[(0,W.jsx)(c.A,{onClick:()=>{ae()},children:"Cancel"}),(0,W.jsx)(c.A,{onClick:async()=>{await(async()=>{if(!z.purpose)return J("Purpose is required"),M("error"),void q(!0);if(!z.payment_lines||0===z.payment_lines.length)return J("At least one payment line is required"),M("error"),void q(!0);if(!z.journal_lines||z.journal_lines.length<2)return J("At least two journal entry lines are required"),M("error"),void q(!0);if((z.journal_lines||[]).reduce((e,t)=>e+(Number(t.debit)||0),0)!==(z.journal_lines||[]).reduce((e,t)=>e+(Number(t.credit)||0),0))return J("Total Debit and Total Credit must be equal"),M("error"),void q(!0);const e=(z.payment_lines||[]).map(e=>{var t;return{payee_contact_id:e.payee_contact_id?Number(e.payee_contact_id):null,payee_display:e.payee_display||(null===(t=n.find(t=>String(t.contact_id)===String(e.payee_contact_id)))||void 0===t?void 0:t.display_name)||"",description:e.description||"",amount:Number(e.amount)||0}}),t=(z.journal_lines||[]).map(e=>({coa_id:e.coa_id||null,debit:Number(e.debit)||0,credit:Number(e.credit)||0,remarks:e.remarks||""})),r={status:z.status||"Draft",cvoucher_date:z.cvoucher_date,purpose:z.purpose,paid_through:z.paid_through||"Bank",prepared_by:z.prepared_by||null,description:z.description||"",payment_lines:e,journal_lines:t},a=e=>null===e||void 0===e||""===e?{id:null,manual:null}:isNaN(Number(e))?{id:null,manual:String(e)}:{id:Number(e),manual:null},i=a(z.reviewed_by),l=a(z.approved_by);i.id?r.reviewer_id=i.id:i.manual&&(r.reviewer_manual=i.manual),l.id?r.approver_id=l.id:l.manual&&(r.approver_manual=l.manual),r.reviewed_by=z.reviewed_by||null,r.approved_by=z.approved_by||null,"multi"===z.mode&&Array.isArray(z.check_lines)?(r.check_lines=(z.check_lines||[]).map(e=>({check_number:e.check_number||e.check_no||null,check_date:e.check_date||null,check_amount:Number(e.check_amount)||0,check_subpayee:e.check_subpayee||null})),r.multiple_checks=1):(r.multiple_checks=0,z.check_no&&(r.check_no=z.check_no),(z.check_amount||0===z.check_amount)&&(r.check_amount=Number(z.check_amount)));try{const e=localStorage.getItem("token");if(f&&f.check_voucher_id)await B.A.put((0,D.c$)("/api/check-vouchers/".concat(f.check_voucher_id)),r,{headers:e?{Authorization:"Bearer ".concat(e)}:{}}),J("Check Voucher updated"),M("success"),q(!0),b(!1),X();else{const t=await B.A.post((0,D.c$)("/api/check-vouchers"),r,{headers:e?{Authorization:"Bearer ".concat(e)}:{}}),n=t.data&&t.data.check_voucher&&t.data.check_voucher.check_voucher_control?t.data.check_voucher.check_voucher_control:null;J(n?"Check Voucher created (".concat(n,")"):"Check Voucher created"),M("success"),q(!0),b(!1),X()}}catch(c){var s,o;J((null===(s=c.response)||void 0===s||null===(o=s.data)||void 0===o?void 0:o.error)||c.message||"Save failed"),M("error"),q(!0)}})(),ae()},variant:"contained",children:"Save"})]})]}),(0,W.jsxs)(v.A,{open:ie,onClose:()=>le(!1),fullWidth:!0,maxWidth:"md",children:[(0,W.jsx)(x.A,{children:"Preview Check Voucher"}),(0,W.jsx)(j.A,{children:se?(0,W.jsxs)("div",{id:"cv-print-area",style:{padding:20,fontFamily:"Arial, sans-serif",color:"#000"},children:[(0,W.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[(0,W.jsxs)("div",{children:[(0,W.jsx)("div",{style:{fontSize:20,fontWeight:700},children:se.company&&(se.company.name||se.company.company_name)||""}),(0,W.jsx)("div",{style:{fontSize:12},children:se.company&&se.company.address||""})]}),(0,W.jsx)("div",{children:se.company&&se.company.logo?(0,W.jsx)("img",{src:se.company.logo,alt:"logo",style:{height:60}}):null})]}),(0,W.jsx)("hr",{}),(0,W.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:10},children:[(0,W.jsxs)("div",{children:[(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"CV Ctrl:"})," ",se.check_voucher_control||se.check_voucher_id]}),(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Prepared:"})," ",(0,I.V)(se.cvoucher_date)]}),(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Purpose:"})," ",se.purpose]})]}),(0,W.jsx)("div",{style:{textAlign:"right"},children:(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Amount:"})," PHP ",se.check_amount||(se.payment_lines&&se.payment_lines.length?se.payment_lines.reduce((e,t)=>e+(Number(t.amount)||0),0):0)]})})]}),(0,W.jsxs)("div",{style:{marginTop:20},children:[(0,W.jsx)("div",{style:{fontWeight:700},children:"Payment Details"}),(0,W.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse",marginTop:8},children:[(0,W.jsx)("thead",{children:(0,W.jsxs)("tr",{children:[(0,W.jsx)("th",{style:{borderBottom:"1px solid #ccc",textAlign:"left"},children:"Payee"}),(0,W.jsx)("th",{style:{borderBottom:"1px solid #ccc",textAlign:"left"},children:"Description"}),(0,W.jsx)("th",{style:{borderBottom:"1px solid #ccc",textAlign:"right"},children:"Amount"})]})}),(0,W.jsx)("tbody",{children:(se.payment_lines||[]).map((e,t)=>(0,W.jsxs)("tr",{children:[(0,W.jsx)("td",{style:{padding:"6px 0"},children:e.payee_display||e.payee_name||e.payee_contact_id||"-"}),(0,W.jsx)("td",{style:{padding:"6px 0"},children:e.description||""}),(0,W.jsx)("td",{style:{padding:"6px 0",textAlign:"right"},children:Number(e.amount||0).toFixed(2)})]},t))})]})]}),(0,W.jsxs)("div",{style:{marginTop:20},children:[(0,W.jsx)("div",{style:{fontWeight:700},children:"Journal Entries"}),(0,W.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse",marginTop:8},children:[(0,W.jsx)("thead",{children:(0,W.jsxs)("tr",{children:[(0,W.jsx)("th",{style:{borderBottom:"1px solid #ccc",textAlign:"left"},children:"COA"}),(0,W.jsx)("th",{style:{borderBottom:"1px solid #ccc",textAlign:"right"},children:"Debit"}),(0,W.jsx)("th",{style:{borderBottom:"1px solid #ccc",textAlign:"right"},children:"Credit"})]})}),(0,W.jsx)("tbody",{children:(se.journal_lines||[]).map((e,t)=>(0,W.jsxs)("tr",{children:[(0,W.jsx)("td",{style:{padding:"6px 0"},children:e.account_name||e.coa_name||e.coa_id||""}),(0,W.jsx)("td",{style:{padding:"6px 0",textAlign:"right"},children:Number(e.debit||0).toFixed(2)}),(0,W.jsx)("td",{style:{padding:"6px 0",textAlign:"right"},children:Number(e.credit||0).toFixed(2)})]},t))})]})]}),(0,W.jsx)("div",{style:{marginTop:20},children:(0,W.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,W.jsxs)("div",{style:{textAlign:"center",width:"30%"},children:[(0,W.jsx)("div",{style:{fontWeight:700},children:"Prepared By"}),(0,W.jsx)("div",{style:{marginTop:24},children:"__________________"}),(0,W.jsx)("div",{style:{marginTop:8,fontSize:12},children:se.prepared_by_name||re(se.prepared_by||se.prepared_by_manual||"")})]}),(0,W.jsxs)("div",{style:{textAlign:"center",width:"30%"},children:[(0,W.jsx)("div",{style:{fontWeight:700},children:"Reviewed By"}),(0,W.jsx)("div",{style:{marginTop:24},children:"__________________"}),(0,W.jsx)("div",{style:{marginTop:8,fontSize:12},children:se.reviewed_by_name||re(se.reviewed_by||se.reviewed_by_manual||"")})]}),(0,W.jsxs)("div",{style:{textAlign:"center",width:"30%"},children:[(0,W.jsx)("div",{style:{fontWeight:700},children:"Approved By"}),(0,W.jsx)("div",{style:{marginTop:24},children:"__________________"}),(0,W.jsx)("div",{style:{marginTop:8,fontSize:12},children:se.approved_by_name||re(se.approved_by||se.approved_by_manual||"")})]})]})})]}):(0,W.jsx)("div",{children:"No preview data"})}),(0,W.jsxs)(S.A,{children:[(0,W.jsx)(c.A,{onClick:()=>le(!1),children:"Close"}),(0,W.jsx)(c.A,{onClick:()=>se&&(async e=>{if(e)try{const n=localStorage.getItem("token"),r={};n&&(r.Authorization="Bearer ".concat(n));const a=await(0,D.S)("/api/check-vouchers/".concat(e,"/pdf"),{headers:r});if(!a.ok){const e=await a.text();let n=e;try{n=JSON.parse(e).error||e}catch(t){n=e}return J(n||"PDF request failed: ".concat(a.status)),M("error"),void q(!0)}if(!(a.headers.get("content-type")||"").includes("application/pdf")){const e=await a.text();let n=e;try{n=JSON.parse(e).error||e}catch(t){n=e}return J(n||"Server did not return a PDF"),M("error"),void q(!0)}const i=await a.blob(),l=URL.createObjectURL(i),s=a.headers.get("content-disposition")||"";let o="check-voucher.pdf";const c=/filename="?([^";]+)"?/.exec(s);c&&c[1]&&(o=c[1]);const d=document.createElement("a");d.href=l,d.download=o,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(l)}catch(t){J((null===t||void 0===t?void 0:t.message)||"Download failed"),M("error"),q(!0)}})(se.check_voucher_id),sx:{mr:1},children:"Download PDF"}),(0,W.jsx)(c.A,{onClick:()=>{const e=document.getElementById("cv-print-area");if(!e)return J("Nothing to print"),M("info"),void q(!0);const t='<!doctype html><html><head><meta charset="utf-8"><title>Check Voucher</title><style>body{font-family: Arial, sans-serif; color:#000; padding:20px;} table{width:100%;border-collapse:collapse;} th,td{padding:6px 4px;} th{border-bottom:1px solid #ccc;}</style></head><body>'.concat(e.innerHTML,"<script> (function(){ function doPrint(){ try{ window.focus(); window.print(); }catch(e){ console.error('Print failed', e); } } if(document.readyState==='complete'){ setTimeout(doPrint,50); } else { window.addEventListener('load', function(){ setTimeout(doPrint,50); }); } window.addEventListener('afterprint', function(){ try{ window.close(); }catch(e){} }); })(); <\/script></body></html>"),n=window.open("","_blank");if(!n)try{var r;const e=document.createElement("iframe");e.style.position="fixed",e.style.right="0",e.style.bottom="0",e.style.width="0",e.style.height="0",e.style.border="0",document.body.appendChild(e);const n=null===(r=e.contentWindow)||void 0===r?void 0:r.document;if(!n)throw new Error("iframe doc unavailable");n.open(),n.write(t),n.close();const a=()=>{try{var t,n;null===(t=e.contentWindow)||void 0===t||t.focus(),null===(n=e.contentWindow)||void 0===n||n.print()}catch(r){J("Print failed in iframe"),M("error"),q(!0)}setTimeout(()=>{try{document.body.removeChild(e)}catch(r){}},500)};return e.onload=a,void setTimeout(a,800)}catch(a){return J("Popup blocked and fallback failed. Allow popups or use Download PDF."),M("error"),void q(!0)}n.document.open(),n.document.write(t),n.document.close()},variant:"contained",children:"Print / Save as PDF"})]})]}),(0,W.jsx)(C.A,{open:F,autoHideDuration:4e3,onClose:()=>q(!1),children:(0,W.jsx)(N.A,{severity:U,sx:{width:"100%"},children:H})})]})};function q(e){let{children:t,value:n,index:r}=e;return(0,W.jsx)("div",{role:"tabpanel",hidden:n!==r,children:n===r&&(0,W.jsx)(a.A,{p:2,children:t})})}const H=()=>{const[e,t]=r.useState(0);return(0,W.jsxs)(a.A,{children:[(0,W.jsx)("h2",{children:"AP Management Module"}),(0,W.jsx)(i.A,{children:(0,W.jsxs)(l.A,{value:e,onChange:(e,n)=>t(n),indicatorColor:"primary",textColor:"primary",children:[(0,W.jsx)(s.A,{label:"Payment Vouchers"}),(0,W.jsx)(s.A,{label:"Disbursement Reports"}),(0,W.jsx)(s.A,{label:"Check Vouchers"})]})}),(0,W.jsx)(q,{value:e,index:0,children:(0,W.jsx)(R,{})}),(0,W.jsx)(q,{value:e,index:1,children:(0,W.jsx)(E,{})}),(0,W.jsx)(q,{value:e,index:2,children:(0,W.jsx)(F,{})})]})}},3518:(e,t,n)=>{function r(e){if(!e)return"";const t="string"===typeof e?new Date(e):e;if(Number.isNaN(t.getTime()))return"";const n=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),a=String(t.getFullYear());return"".concat(n,"/").concat(r,"/").concat(a)}n.d(t,{V:()=>r})}}]);
//# sourceMappingURL=46.c997e991.chunk.js.map